{"remainingRequest":"/Users/marceltanner/Google Drive/Kreativs/Interaktiv/Self Driving/vue_2_selfdriving/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/marceltanner/Google Drive/Kreativs/Interaktiv/Self Driving/vue_2_selfdriving/src/App.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/marceltanner/Google Drive/Kreativs/Interaktiv/Self Driving/vue_2_selfdriving/src/App.vue","mtime":1662248721476},{"path":"/Users/marceltanner/Google Drive/Kreativs/Interaktiv/Self Driving/vue_2_selfdriving/node_modules/cache-loader/dist/cjs.js","mtime":1644164856547},{"path":"/Users/marceltanner/Google Drive/Kreativs/Interaktiv/Self Driving/vue_2_selfdriving/node_modules/babel-loader/lib/index.js","mtime":1644164857550},{"path":"/Users/marceltanner/Google Drive/Kreativs/Interaktiv/Self Driving/vue_2_selfdriving/node_modules/cache-loader/dist/cjs.js","mtime":1644164856547},{"path":"/Users/marceltanner/Google Drive/Kreativs/Interaktiv/Self Driving/vue_2_selfdriving/node_modules/vue-loader/lib/index.js","mtime":1644164857852}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KCgpjb25zdCB0ZiA9IHJlcXVpcmUoJ0B0ZW5zb3JmbG93L3RmanMnKTsKCmV4cG9ydCBkZWZhdWx0IHsKICBuYW1lOiAnQXBwJywKICBkYXRhKCkgewogICAgcmV0dXJuIHsKICAgICAgY3R4OiBudWxsLAogICAgICB3b3JsZFdpZHRoOiAyNTYsCiAgICAgIHdvcmxkSGVpZ2h0OiAyNTYsCiAgICAgIGltZ1dvcmxkOiBudWxsLAogICAgICB3b3JsZExvYWRlZDogZmFsc2UsCiAgICAgIGZwczogbnVsbCwKICAgICAgZnBzQ291bnRlcjogbnVsbCwKICAgICAgdGljazogdHJ1ZSwKICAgICAgdGlja1RpbWU6IG51bGwsCiAgICAgIGR1cmF0aW9uOiAtMSwKICAgICAgZHVyYXRpb25TdHJpbmc6IG51bGwsCiAgICAgIGNhcjogewogICAgICAgIHdpZHRoOiA4LAogICAgICAgIGxlbmd0aDogMTYsCiAgICAgICAgeDogMjU2IC8gMiAqIDAuMjUsCiAgICAgICAgeTogMjU2IC8gMiAqIDEuNSwKICAgICAgICBzcGVlZDogMC41LAogICAgICAgIHN0ZWVyaW5nU3BlZWQ6IDAuMDI1LAogICAgICAgIGFuZ2xlOiAwCiAgICAgIH0sCiAgICAgIHZpZXdTaXplOiAzMiwKICAgICAgdmlld1JlZHVjdGlvbjogMywKICAgICAgdmlld1JlZHVjZWRTaXplOiBudWxsLAogICAgICB2aWV3UGl4ZWxzOiBudWxsLAogICAgICBzdGVlcmluZzogbnVsbCwKICAgICAgc2FtcGxlczogW10sCiAgICAgIHNhbXBsZXNNYXhMZW5ndGg6IDQwOTYsCiAgICAgIHRyYWluaW5nU2FtcGxlczogbnVsbCwKICAgICAgdHJhaW5pbmdTYW1wbGVzTWF4TGVuZ3RoOiA0MDk2LAogICAgICBiYWRSZXdhcmRzOiAwLAogICAgICBiYWRSZXdhcmRzSW5BUm93OiAwLAogICAgICBzY29yZTogMCwKICAgICAgbGFzdFNjb3JlOiBudWxsLAogICAgICBoaWdoc2NvcmVzOiBbXSwKICAgICAgaGlnaHNjb3Jlc01heExlbmd0aDogMTUsCiAgICAgIGhpZ2hzY29yZXNNYXhTaG93bjogMTUsCiAgICAgIHRyYWluaW5nOiBmYWxzZSwKICAgICAgdHJhaW5pbmdQcm9ncmVzczogMCwKICAgICAgbW9kZWxzOiB1bmRlZmluZWQsCiAgICAgIG51bWJlck9mTW9kZWxzOiAxMCwKICAgICAgbW9kZWxJbmRleDogMAogICAgfQogIH0sCiAgY29tcHV0ZWQ6IHsKICAgIHJlZHVjZWRWaWV3U2l6ZSgpIHsKICAgICAgbGV0IHJlZHVjZWRTaXplID0gdGhpcy52aWV3U2l6ZTsKICAgICAgZm9yKCBsZXQgaSA9IDA7IGkgPCB0aGlzLnZpZXdSZWR1Y3Rpb247IGkrKyApIHsKICAgICAgICByZWR1Y2VkU2l6ZSA9IHJlZHVjZWRTaXplIC8gMjsKICAgICAgfQogICAgICByZXR1cm4gcmVkdWNlZFNpemU7CiAgICB9LAogICAgaGlnaHNjb3Jlc1Nob3duKCkgewogICAgICByZXR1cm4gdGhpcy5oaWdoc2NvcmVzLnNsaWNlKDAsdGhpcy5oaWdoc2NvcmVzTWF4U2hvd24pOwogICAgfQogIH0sCiAgbW91bnRlZCgpIHsKICAgIHRoaXMuY3R4ID0gdGhpcy4kcmVmcy5jYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICAgIHRoaXMuaW1nV29ybGQgPSBuZXcgSW1hZ2UodGhpcy53b3JsZFdpZHRoLHRoaXMud29ybGRIZWlnaHQpOwogICAgdGhpcy5pbWdXb3JsZC5zcmMgPSByZXF1aXJlKCcvc3JjL2Fzc2V0cy93b3JsZDQuanBnJyk7CiAgICBjb25zdCBhcHAgPSB0aGlzOwogICAgdGhpcy5pbWdXb3JsZC5vbmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgYXBwLndvcmxkTG9hZGVkID0gdHJ1ZTsKICAgIH0KICAgIC8vZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRoaXMua2V5RG93bik7CiAgICAvL2RvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgdGhpcy5rZXlVcCk7CgogICAgdGhpcy5jdHhWaWV3U25hcHNob3QgPSB0aGlzLiRyZWZzLnZpZXdTbmFwc2hvdENhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwogICAgdGhpcy5jdHhDYXJTbmFwc2hvdCA9IHRoaXMuJHJlZnMuY2FyU25hcHNob3RDYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKCiAgICB0aGlzLmN0eENhciA9IHRoaXMuJHJlZnMuY2FyQ2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgICB0aGlzLmN0eFZpZXcgPSB0aGlzLiRyZWZzLnZpZXdDYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICAgIHRoaXMuY3R4Vmlld1JlZHVjZWQgPSB0aGlzLiRyZWZzLnZpZXdDYW52YXNSZWR1Y2VkLmdldENvbnRleHQoIjJkIik7CgogICAgdGhpcy5jdHhTdGF0cyA9IHRoaXMuJHJlZnMuc3RhdHNDYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKCgogICAgdGhpcy52aWV3UmVkdWNlZFNpemUgPSB0aGlzLnZpZXdTaXplOwogICAgZm9yKCBsZXQgaSA9IDA7IGkgPCB0aGlzLnZpZXdSZWR1Y3Rpb247IGkrKyApIHsKICAgICAgdGhpcy52aWV3UmVkdWNlZFNpemUgPSB0aGlzLnZpZXdSZWR1Y2VkU2l6ZSAvIDI7CiAgICB9CgogICAgdGhpcy5tb2RlbHMgPSBuZXcgQXJyYXkodGhpcy5udW1iZXJPZk1vZGVscyk7CiAgICB0aGlzLmNyZWF0ZU1vZGVsKHRoaXMubW9kZWxJbmRleCk7CgogICAgdGhpcy5yZWZyZXNoTG9vcCgpOwogIH0sCiAgbWV0aG9kczogewogICAgY3JlYXRlTW9kZWwoIG1vZGVsSW5kZXggKSB7CiAgICAgIGNvbnNvbGUubG9nKCJjcmVhdGluZyBtb2RlbCAuLi4iKTsKICAgICAgY29uc3QgbnVtYmVyT2ZMYXllcnMgPSAgMiArIE1hdGgucm91bmQoTWF0aC5yYW5kb20oKSk7CiAgICAgIGxldCBsYXllcnMgPSBuZXcgQXJyYXkoIG51bWJlck9mTGF5ZXJzICk7CiAgICAgIGZvciggbGV0IGkgPSBudW1iZXJPZkxheWVycy0xOyBpID49IDA7IGktLSApIHsKICAgICAgICBpZiggaSA9PT0gbnVtYmVyT2ZMYXllcnMtMSApIHsKICAgICAgICAgIC8vIGxhc3QgbGF5ZXIKICAgICAgICAgIGxheWVyc1tpXSA9IHsKICAgICAgICAgICAgdW5pdHM6IDEsCiAgICAgICAgICAgIGFjdGl2YXRpb246ICJzaWdtb2lkIgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICBsYXllcnNbaV0gPSB7CiAgICAgICAgICAgIHVuaXRzOiAzICsgTWF0aC5jZWlsKCBNYXRoLnJhbmRvbSgpKjE1ICksCiAgICAgICAgICAgIGFjdGl2YXRpb246IFsicmVsdSIsInNpZ21vaWQiXVtNYXRoLnJvdW5kKE1hdGgucmFuZG9tKCkpXQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5tb2RlbHNbbW9kZWxJbmRleF0gPSB7CiAgICAgICAgbGF5ZXJzOiBsYXllcnMsCiAgICAgICAgdHJhaW5pbmdzOiAwLAogICAgICAgIGhpZ2hzY29yZTogdW5kZWZpbmVkLAogICAgICAgIG5hbWU6IG1vZGVsSW5kZXgrMSwKICAgICAgICBjaGlsZHJlbjogMAogICAgICB9OwoKICAgICAgLy8gY3JlYXRlIG1vZGVsIHdpdGggbGF5ZXJzCiAgICAgIHRoaXMubW9kZWxzW21vZGVsSW5kZXhdLm1vZGVsID0gdGYuc2VxdWVudGlhbCgpOwogICAgICBmb3IoIGxldCBpID0gMDsgaSA8IGxheWVycy5sZW5ndGg7IGkrKyApIHsKICAgICAgICBpZiggaSA9PT0gMCApIHsKICAgICAgICAgIC8vIGZpcnN0IGxheWVyCiAgICAgICAgICB0aGlzLm1vZGVsc1ttb2RlbEluZGV4XS5tb2RlbC5hZGQodGYubGF5ZXJzLmRlbnNlKHtpbnB1dFNoYXBlOiB0aGlzLnZpZXdSZWR1Y2VkU2l6ZSp0aGlzLnZpZXdSZWR1Y2VkU2l6ZSwgYWN0aXZhdGlvbjogbGF5ZXJzW2ldLmFjdGl2YXRpb24sIHVuaXRzOiBsYXllcnNbaV0udW5pdHN9KSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgdGhpcy5tb2RlbHNbbW9kZWxJbmRleF0ubW9kZWwuYWRkKHRmLmxheWVycy5kZW5zZSh7YWN0aXZhdGlvbjogbGF5ZXJzW2ldLmFjdGl2YXRpb24sIHVuaXRzOiBsYXllcnNbaV0udW5pdHN9KSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8qCiAgICAgIHRoaXMubW9kZWxzW2ldLm1vZGVsLmFkZCh0Zi5sYXllcnMuZGVuc2Uoe2lucHV0U2hhcGU6IHRoaXMudmlld1JlZHVjZWRTaXplKnRoaXMudmlld1JlZHVjZWRTaXplLCBhY3RpdmF0aW9uOiAicmVsdSIsIHVuaXRzOiAxMH0pKTsKICAgICAgdGhpcy5tb2RlbHNbaV0ubW9kZWwuYWRkKHRmLmxheWVycy5kZW5zZSh7YWN0aXZhdGlvbjogInJlbHUiLCB1bml0czogNX0pKTsKICAgICAgdGhpcy5tb2RlbHNbaV0ubW9kZWwuYWRkKHRmLmxheWVycy5kZW5zZSh7YWN0aXZhdGlvbjogInNpZ21vaWQiLCB1bml0czogMX0pKTsKICAgICAgKi8KICAgICAgLy90aGlzLm1vZGVsc1tpXS5hZGQodGYubGF5ZXJzLmRlbnNlKHthY3RpdmF0aW9uOiAicmVsdSIsIHVuaXRzOiAxfSkpOwogICAgICB0aGlzLm1vZGVsc1ttb2RlbEluZGV4XS5tb2RlbC5jb21waWxlKHtsb3NzOidiaW5hcnlDcm9zc2VudHJvcHknLG9wdGltaXplcjp0Zi50cmFpbi5ybXNwcm9wKDAuMSksbWV0cmljczpbJ2FjY3VyYWN5J119KTsKICAgICAgLy90aGlzLm1vZGVsLmNvbXBpbGUoe2xvc3M6J2NhdGVnb3JpY2FsQ3Jvc3NlbnRyb3B5JyxvcHRpbWl6ZXI6dGYudHJhaW4uYWRhbSgpLG1ldHJpY3M6WydhY2N1cmFjeSddfSk7CiAgICB9LAogICAgYXN5bmMgdHJhaW4oKSB7CgogICAgICAvLyBjaGVjayBpZiBuZXcgaGlnaHNjb3JlOgogICAgICBsZXQgaGlnaHNjb3JlT2ZNb2RlbCA9IHRoaXMuaGlnaHNjb3Jlcy5maW5kKGVsID0+IGVsLm1vZGVsSW5kZXggPT09IHRoaXMubW9kZWxJbmRleCApOwogICAgICBpZiggaGlnaHNjb3JlT2ZNb2RlbCApIHsKICAgICAgICB0aGlzLm1vZGVsc1t0aGlzLm1vZGVsSW5kZXhdLmhpZ2hzY29yZSA9IGhpZ2hzY29yZU9mTW9kZWwuc2NvcmU7CiAgICAgIH0KCiAgICAgIC8vIHN3aXRjaCB0byBuZXh0IG1vZGVsCiAgICAgIHRoaXMubW9kZWxJbmRleCA9ICh0aGlzLm1vZGVsSW5kZXggKzEpICUgdGhpcy5udW1iZXJPZk1vZGVsczsKCiAgICAgIC8vIGNyZWF0ZSBvciBtYWtlIGNsb25lLCBpZiBuZWNlc3NhcnkKICAgICAgaWYoICF0aGlzLm1vZGVsc1t0aGlzLm1vZGVsSW5kZXhdICkgewogICAgICAgIHRoaXMuY3JlYXRlTW9kZWwodGhpcy5tb2RlbEluZGV4KTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICAvLyBjaGVjayBmb3IgbmV3IGhpZ2hzY29yZQogICAgICAgIGxldCBoaWdoc2NvcmVPZk1vZGVsID0gdGhpcy5oaWdoc2NvcmVzLmZpbmQoZWwgPT4gZWwubW9kZWxJbmRleCA9PT0gdGhpcy5tb2RlbEluZGV4ICk7CiAgICAgICAgaWYoICFoaWdoc2NvcmVPZk1vZGVsICkgewogICAgICAgICAgLy8gcmVwbGFjZSBtb2RlbAoKICAgICAgICAgIGxldCByYW5kb20gPSBNYXRoLnJhbmRvbSgpOwogICAgICAgICAgbGV0IGhpZ2hzY29yZUluZGV4OwogICAgICAgICAgaWYoIHJhbmRvbSA+IDEtMC4xODIgKSB7CiAgICAgICAgICAgIGhpZ2hzY29yZUluZGV4ID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYoIHJhbmRvbSA+IDEgLSAwLjE4MiAtIDAuMTYzKSB7CiAgICAgICAgICAgIGhpZ2hzY29yZUluZGV4ID0gMTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYoIHJhbmRvbSA+IDEgLSAwLjE4MiAtIDAuMTYzIC0gMC4xNDYgKSB7CiAgICAgICAgICAgIGhpZ2hzY29yZUluZGV4ID0gMjsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYoIHJhbmRvbSA+IDEgLSAwLjE4MiAtIDAuMTYzIC0gMC4xNDYgLSAwLjEyNyApIHsKICAgICAgICAgICAgaGlnaHNjb3JlSW5kZXggPSAzOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiggcmFuZG9tID4gMSAtIDAuMTgyIC0gMC4xNjMgLSAwLjE0NiAtIDAuMTI3IC0gMC4xMDkgKSB7CiAgICAgICAgICAgIGhpZ2hzY29yZUluZGV4ID0gNDsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYoIHJhbmRvbSA+IDEgLSAwLjE4MiAtIDAuMTYzIC0gMC4xNDYgLSAwLjEyNyAtIDAuMTA5IC0gMC4wOTEgKSB7CiAgICAgICAgICAgIGhpZ2hzY29yZUluZGV4ID0gNTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYoIHJhbmRvbSA+IDEgLSAwLjE4MiAtIDAuMTYzIC0gMC4xNDYgLSAwLjEyNyAtIDAuMTA5IC0gMC4wOTEgLSAwLjA3MyApIHsKICAgICAgICAgICAgaGlnaHNjb3JlSW5kZXggPSA2OwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiggcmFuZG9tID4gMSAtIDAuMTgyIC0gMC4xNjMgLSAwLjE0NiAtIDAuMTI3IC0gMC4xMDkgLSAwLjA5MSAtIDAuMDczIC0gMC4wNTQgKSB7CiAgICAgICAgICAgIGhpZ2hzY29yZUluZGV4ID0gNzsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYoIHJhbmRvbSA+IDEgLSAwLjE4MiAtIDAuMTYzIC0gMC4xNDYgLSAwLjEyNyAtIDAuMTA5IC0gMC4wOTEgLSAwLjA3MyAtIDAuMDU0IC0gMC4wMzcgKSB7CiAgICAgICAgICAgIGhpZ2hzY29yZUluZGV4ID0gODsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYoIHJhbmRvbSA+IDEgLSAwLjE4MiAtIDAuMTYzIC0gMC4xNDYgLSAwLjEyNyAtIDAuMTA5IC0gMC4wOTEgLSAwLjA3MyAtIDAuMDU0IC0gMC4wMzcgLSAwLjAxOCApIHsKICAgICAgICAgICAgaGlnaHNjb3JlSW5kZXggPSA5OwogICAgICAgICAgfQoKICAgICAgICAgIGNvbnN0IG1vdGhlciA9IHRoaXMubW9kZWxzWyB0aGlzLmhpZ2hzY29yZXNbaGlnaHNjb3JlSW5kZXhdLm1vZGVsSW5kZXggXTsKICAgICAgICAgIHRoaXMubW9kZWxzW3RoaXMubW9kZWxJbmRleF0gPSB7Li4ubW90aGVyfTsKICAgICAgICAgIHRoaXMubW9kZWxzW3RoaXMubW9kZWxJbmRleF0udHJhaW5pbmdzID0gMDsKICAgICAgICAgIHRoaXMubW9kZWxzW3RoaXMubW9kZWxJbmRleF0uaGlnaHNjb3JlID0gdW5kZWZpbmVkOwogICAgICAgICAgbW90aGVyLmNoaWxkcmVuKys7CiAgICAgICAgICB0aGlzLm1vZGVsc1t0aGlzLm1vZGVsSW5kZXhdLm5hbWUgPSBtb3RoZXIubmFtZSsiLiIrbW90aGVyLmNoaWxkcmVuOwogICAgICAgIH0KCiAgICAgIH0KCiAgICAgIHRoaXMudHJhaW5pbmcgPSB0cnVlOwoKICAgICAgdGhpcy50cmFpbmluZ1NhbXBsZXMgPSBbXTsKICAgICAgZm9yKCBsZXQgaSA9IDA7IGkgPCB0aGlzLmhpZ2hzY29yZXMubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgbGV0IHNhbXBsZXMgPSBbXTsKICAgICAgICBmb3IoIGxldCBqID0gMDsgaiA8IHRoaXMuaGlnaHNjb3Jlc1tpXS5zYW1wbGVzLmxlbmd0aDsgaisrICkgewogICAgICAgICAgaWYoIHRoaXMuaGlnaHNjb3Jlc1tpXS5zYW1wbGVzW2pdLnJld2FyZCA+IDAuNSApIHsKICAgICAgICAgICAgLy8gdXNlIG9ubHkgZ29vZCByZXdhcmRzCiAgICAgICAgICAgIHNhbXBsZXMucHVzaCggdGhpcy5oaWdoc2NvcmVzW2ldLnNhbXBsZXNbal0gKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy50cmFpbmluZ1NhbXBsZXMucHVzaCguLi5zYW1wbGVzKTsKICAgICAgfQogICAgICAvLyByYW5kb21pc2UgYW5kIHNsaWNlCiAgICAgIHRoaXMudHJhaW5pbmdTYW1wbGVzLnNvcnQoZnVuY3Rpb24oKXtyZXR1cm4gMC41IC0gTWF0aC5yYW5kb20oKX0pOwogICAgICB0aGlzLnRyYWluaW5nU2FtcGxlcyA9IHRoaXMudHJhaW5pbmdTYW1wbGVzLnNsaWNlKDAsdGhpcy50cmFpbmluZ1NhbXBsZXNNYXhMZW5ndGgpOwoKICAgICAgY29uc29sZS5sb2coInRvdGFsIG51bWJlciBvZiBzYW1wbGVzOiAiK3RoaXMudHJhaW5pbmdTYW1wbGVzLmxlbmd0aCk7CgogICAgICBsZXQgZmVhdHVyZVZhbHVlc1RyYWluaW5nID0gW107CiAgICAgIGxldCBsYWJlbFZhbHVlc1RyYWluaW5nID0gW107CiAgICAgIGZvciggbGV0IGkgPSAwOyBpIDwgdGhpcy50cmFpbmluZ1NhbXBsZXMubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgbGV0IGZlYXR1cmVWYWx1ZVRyYWluaW5nID0gWy4uLnRoaXMudHJhaW5pbmdTYW1wbGVzW2ldLnN0YXRlXTsKICAgICAgICAvL2ZlYXR1cmVWYWx1ZVRyYWluaW5nLnB1c2goIHRoaXMudHJhaW5pbmdTYW1wbGVzW2ldLnJld2FyZCApOwogICAgICAgIGZlYXR1cmVWYWx1ZXNUcmFpbmluZy5wdXNoKCBmZWF0dXJlVmFsdWVUcmFpbmluZyApOwogICAgICAgIGxhYmVsVmFsdWVzVHJhaW5pbmcucHVzaCggdGhpcy50cmFpbmluZ1NhbXBsZXNbaV0uYWN0aW9uICk7CiAgICAgIH0KICAgICAgY29uc3QgZmVhdHVyZVRlbnNvclRyYWluaW5nID0gdGYudGVuc29yMmQoIGZlYXR1cmVWYWx1ZXNUcmFpbmluZywgW2ZlYXR1cmVWYWx1ZXNUcmFpbmluZy5sZW5ndGgsIGZlYXR1cmVWYWx1ZXNUcmFpbmluZ1swXS5sZW5ndGhdICk7CiAgICAgIGNvbnN0IGxhYmVsVGVuc29yVHJhaW5pbmcgPSB0Zi50ZW5zb3IyZCggbGFiZWxWYWx1ZXNUcmFpbmluZywgW2xhYmVsVmFsdWVzVHJhaW5pbmcubGVuZ3RoLCAxXSApOwoKICAgICAgY29uc29sZS5sb2coInRyYWluIG1vZGVsIC4uLiIpOwogICAgICBhd2FpdCB0aGlzLnRyYWluTW9kZWwoIHRoaXMubW9kZWxJbmRleCwgZmVhdHVyZVRlbnNvclRyYWluaW5nLCBsYWJlbFRlbnNvclRyYWluaW5nLCBNYXRoLm1pbigxMCwgdGhpcy50cmFpbmluZ1NhbXBsZXNNYXhMZW5ndGgvdGhpcy50cmFpbmluZ1NhbXBsZXMubGVuZ3RoKSoxMCApOwoKICAgICAgdGhpcy50cmFpbmluZyA9IGZhbHNlOwogICAgICB0aGlzLnRyYWluaW5nUHJvZ3Jlc3MgPSAwOwoKICAgICAgdGhpcy5tb2RlbHNbdGhpcy5tb2RlbEluZGV4XS50cmFpbmluZ3MgKz0gMTsKICAgIH0sCiAgICBhc3luYyB0cmFpbk1vZGVsKCBtb2RlbEluZGV4LCBmZWF0dXJlVGVuc29yVHJhaW5pbmcsIGxhYmVsVGVuc29yVHJhaW5pbmcsIGVwb2NocyApIHsKICAgICAgY29uc3QgcmVmID0gdGhpczsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxzW21vZGVsSW5kZXhdLm1vZGVsLmZpdCggZmVhdHVyZVRlbnNvclRyYWluaW5nLCBsYWJlbFRlbnNvclRyYWluaW5nLCB7CiAgICAgICAgZXBvY2hzLAogICAgICAgIC8vdmFsaWRhdGlvblNwbGl0OiAwLjIsCiAgICAgICAgY2FsbGJhY2tzOiB7CiAgICAgICAgICBvbkVwb2NoRW5kOiBmdW5jdGlvbihlcG9jaCkgewogICAgICAgICAgICByZWYudHJhaW5pbmdQcm9ncmVzcyA9IE1hdGgucm91bmQoIGVwb2NoIC8gZXBvY2hzICogMTAwICk7CiAgICAgICAgICB9LAogICAgICAgICAgb25UcmFpbkVuZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJkb25lIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBhc3luYyBwcmVkaWN0KCBtb2RlbEluZGV4LCBpbnB1dCApIHsKICAgICAgcmV0dXJuIHRmLnRpZHkoICgpID0+IHsKICAgICAgICBjb25zdCBpbnB1dFRlbnNvciA9IHRmLnRlbnNvcjJkKFtpbnB1dF0sWzEsIHRoaXMudmlld1JlZHVjZWRTaXplKnRoaXMudmlld1JlZHVjZWRTaXplXSk7CiAgICAgICAgY29uc3Qgb3V0cHV0VGVuc29yID0gdGhpcy5tb2RlbHNbbW9kZWxJbmRleF0ubW9kZWwucHJlZGljdCggaW5wdXRUZW5zb3IgKTsKICAgICAgICBjb25zdCBvdXRwdXRWYWx1ZSA9IG91dHB1dFRlbnNvci5kYXRhU3luYygpOwoKICAgICAgICByZXR1cm4gb3V0cHV0VmFsdWU7CiAgICAgIH0pOwogICAgfSwKICAgIGFzeW5jIGdldFN0ZWVyaW5nKCkgewogICAgICB0aGlzLnByZWRpY3Rpb24gPSBhd2FpdCB0aGlzLnByZWRpY3QoIHRoaXMubW9kZWxJbmRleCwgdGhpcy50ZXN0aW5nRGF0YUlucHV0ICk7CiAgICAgIHRoaXMucHJlZGljdGlvbiA9IE1hdGgubWF4KCAwLCB0aGlzLnByZWRpY3Rpb24gICkKICAgICAgcmV0dXJuIHRoaXMucHJlZGljdGlvbjsKICAgIH0sCiAgICByZWZyZXNoTG9vcCgpIHsKICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7CiAgICAgICAgY29uc3Qgbm93ID0gcGVyZm9ybWFuY2Uubm93KCk7CiAgICAgICAgaWYoIHRoaXMudGljayApIHsKICAgICAgICAgIHRoaXMudGlja1RpbWUgPSBub3c7CiAgICAgICAgICB0aGlzLmZwcyA9IHRoaXMuZnBzQ291bnRlcjsKICAgICAgICAgIHRoaXMuZnBzQ291bnRlciA9IDA7CiAgICAgICAgICB0aGlzLnRpY2sgPSBmYWxzZTsKCiAgICAgICAgICB0aGlzLmR1cmF0aW9uKys7CiAgICAgICAgICBjb25zdCBkYXRlID0gbmV3IERhdGUoMCk7CiAgICAgICAgICBkYXRlLnNldFNlY29uZHModGhpcy5kdXJhdGlvbik7IC8vIHNwZWNpZnkgdmFsdWUgZm9yIFNFQ09ORFMgaGVyZQogICAgICAgICAgdGhpcy5kdXJhdGlvblN0cmluZyA9IGRhdGUudG9JU09TdHJpbmcoKS5zdWJzdHIoMTEsIDgpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgIHRoaXMuZnBzQ291bnRlcisrOwogICAgICAgICAgaWYoIG5vdyA+PSB0aGlzLnRpY2tUaW1lICsgMTAwMCApIHsKICAgICAgICAgICAgdGhpcy50aWNrID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuZW50ZXJGcmFtZSgpOwoKICAgICAgICB0aGlzLnJlZnJlc2hMb29wKCk7CiAgICAgIH0pOwogICAgfSwKICAgIGVudGVyRnJhbWUoKSB7CiAgICAgIGlmKCB0aGlzLndvcmxkTG9hZGVkICYmICF0aGlzLnRyYWluaW5nICkgewogICAgICAgIHRoaXMuZHJhd1dvcmxkKCk7CiAgICAgICAgdGhpcy5nZXRWaWV3KCk7CiAgICAgICAgdGhpcy5tb3ZlQ2FyKCk7CiAgICAgIH0KICAgIH0sCiAgICBkcmF3U3RhdHMoKSB7CiAgICAgIHRoaXMuY3R4U3RhdHMuY2xlYXJSZWN0KCAwLCAwLCB0aGlzLmN0eFN0YXRzLmNhbnZhcy53aWR0aCwgdGhpcy5jdHhTdGF0cy5jYW52YXMuaGVpZ2h0ICk7CiAgICAgIC8vdGhpcy5jdHhTdGF0cy5maWxsUmVjdCgwLCAwLCB0aGlzLmN0eFN0YXRzLmNhbnZhcy53aWR0aCwgdGhpcy5jdHhTdGF0cy5jYW52YXMuaGVpZ2h0KTsKICAgICAgLy90aGlzLmN0eFN0YXRzLnN0cm9rZVN0eWxlID0gIiNmZmZmZmYiOwogICAgICBjb25zdCBudW1iZXJPZnNhbXBsZXNEcmF3biA9IE1hdGgubWluKDUxMiwgdGhpcy5zYW1wbGVzLmxlbmd0aCk7CiAgICAgIGZvciggbGV0IGkgPSAwOyBpIDwgbnVtYmVyT2ZzYW1wbGVzRHJhd247IGkrKyApIHsKICAgICAgICAvKgogICAgICAgIHRoaXMuY3R4U3RhdHMubW92ZVRvKCB0aGlzLnNhbXBsZXNbaV0uYWN0aW9uICogdGhpcy5jdHhTdGF0cy5jYW52YXMud2lkdGgsIHRoaXMuY3R4U3RhdHMuY2FudmFzLmhlaWdodC90aGlzLnNhbXBsZXMubGVuZ3RoICogaSApOwogICAgICAgIHRoaXMuY3R4U3RhdHMubGluZVRvKCB0aGlzLnNhbXBsZXNbaSsxXS5hY3Rpb24gKiB0aGlzLmN0eFN0YXRzLmNhbnZhcy53aWR0aCwgdGhpcy5jdHhTdGF0cy5jYW52YXMuaGVpZ2h0L3RoaXMuc2FtcGxlcy5sZW5ndGggKiAoaSsxKSApOwogICAgICAgICovCiAgICAgICAgdGhpcy5jdHhTdGF0cy5iZWdpblBhdGgoKTsKICAgICAgICB0aGlzLmN0eFN0YXRzLmZpbGxTdHlsZSA9ICIjZmZmZmZmIjsKICAgICAgICB0aGlzLmN0eFN0YXRzLmFyYyh0aGlzLnNhbXBsZXNbaV0uYWN0aW9uUHJlZGljdGVkICogdGhpcy5jdHhTdGF0cy5jYW52YXMud2lkdGgsIHRoaXMuY3R4U3RhdHMuY2FudmFzLmhlaWdodC9udW1iZXJPZnNhbXBsZXNEcmF3biAqIGksIDEsIDAsIDIgKiBNYXRoLlBJKTsKICAgICAgICB0aGlzLmN0eFN0YXRzLmZpbGwoKTsKCiAgICAgICAgdGhpcy5jdHhTdGF0cy5iZWdpblBhdGgoKTsKICAgICAgICBsZXQgcmdiOwogICAgICAgIGlmKCB0aGlzLnNhbXBsZXNbaV0ucmV3YXJkID49IDAuNSApIHsKICAgICAgICAgIC8vcmdiID0gIiMwMGZmMDAiOwogICAgICAgICAgcmdiID0gIiMwMCIrIE1hdGgucm91bmQoIHRoaXMuc2FtcGxlc1tpXS5yZXdhcmQgKiAyNTUgKS50b1N0cmluZygxNikgKyAiMDAiOwogICAgICAgICAgdGhpcy5jdHhTdGF0cy5maWxsU3R5bGUgPSByZ2I7CiAgICAgICAgICB0aGlzLmN0eFN0YXRzLmFyYyh0aGlzLnNhbXBsZXNbaV0uYWN0aW9uICogdGhpcy5jdHhTdGF0cy5jYW52YXMud2lkdGgsIHRoaXMuY3R4U3RhdHMuY2FudmFzLmhlaWdodC9udW1iZXJPZnNhbXBsZXNEcmF3biAqIGksIDEsIDAsIDIgKiBNYXRoLlBJKTsKICAgICAgICAgIHRoaXMuY3R4U3RhdHMuZmlsbCgpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgIC8vcmdiID0gIiNmZjAwMDAiOwogICAgICAgICAgcmdiID0gIiMiKyBNYXRoLnJvdW5kKCAoMS10aGlzLnNhbXBsZXNbaV0ucmV3YXJkKSAqIDI1NSApLnRvU3RyaW5nKDE2KSArICIwMDAwIjsKICAgICAgICAgIHRoaXMuY3R4U3RhdHMuZmlsbFN0eWxlID0gcmdiOwogICAgICAgICAgdGhpcy5jdHhTdGF0cy5hcmModGhpcy5zYW1wbGVzW2ldLmFjdGlvbiAqIHRoaXMuY3R4U3RhdHMuY2FudmFzLndpZHRoLCB0aGlzLmN0eFN0YXRzLmNhbnZhcy5oZWlnaHQvbnVtYmVyT2ZzYW1wbGVzRHJhd24gKiBpLCAxLCAwLCAyICogTWF0aC5QSSk7CiAgICAgICAgICB0aGlzLmN0eFN0YXRzLmZpbGwoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy90aGlzLmN0eFN0YXRzLnN0cm9rZSgpOwogICAgfSwKICAgIG1vdmVDYXIoKSB7CiAgICAgIHRoaXMudGVzdGluZ0RhdGFJbnB1dCA9IFsuLi50aGlzLnZpZXdQaXhlbHNdOwogICAgICAvL3RoaXMudGVzdGluZ0RhdGFJbnB1dC5wdXNoKDEuMCk7CiAgICAgIGNvbnN0IHJlZiA9IHRoaXM7CiAgICAgIHRoaXMuZ2V0U3RlZXJpbmcoKS50aGVuKCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIC8vY29uc29sZS5sb2coInByZWRpY3RlZCBzdGVlcmluZzogIit2YWx1ZSk7CiAgICAgICAgdmFsdWUgPSBNYXRoLm1pbiggdmFsdWUsIDEgKTsKICAgICAgICB2YWx1ZSA9IE1hdGgubWF4KCB2YWx1ZSwgMCApOwogICAgICAgIC8vY29uc29sZS5sb2coInByZWRpY3RlZCBzdGVlcmluZzogIit2YWx1ZSk7CiAgICAgICAgcmVmLmNhci5zdGVlcmluZ1ByZWRpY3RlZCA9IHZhbHVlOwoKICAgICAgICBsZXQgcmFuZG9taXNhdGlvbiA9IDA7CiAgICAgICAgaWYoIHJlZi5zYW1wbGVzWzBdICkgewogICAgICAgICAgaWYoIHJlZi5zYW1wbGVzWzBdLnJld2FyZCA8IDAuNSApIHsKICAgICAgICAgICAgcmFuZG9taXNhdGlvbiA9IE1hdGgubWluKCAwLjc1LCAocmVmLmJhZFJld2FyZHMvcmVmLnNhbXBsZXMubGVuZ3RoKSAqIHJlZi5iYWRSZXdhcmRzSW5BUm93ICk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgcmFuZG9taXNhdGlvbiA9IDAuMDU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgcmFuZG9taXNhdGlvbiA9IDAuNzU7CiAgICAgICAgfQoKICAgICAgICAvL2NvbnNvbGUubG9nKCJyYW5kb21pc2F0aW9uOiAiK3JhbmRvbWlzYXRpb24pOwogICAgICAgIGNvbnN0IHJhbmRvbSA9IE1hdGgucmFuZG9tKCk7CiAgICAgICAgbGV0IHJhbmRvbWlzZWRWYWx1ZSA9IHZhbHVlIC0gcmFuZG9taXNhdGlvbioxICsgcmFuZG9tICogcmFuZG9taXNhdGlvbioyOwogICAgICAgIHJhbmRvbWlzZWRWYWx1ZSA9IE1hdGgubWluKCByYW5kb21pc2VkVmFsdWUsIDEgKTsKICAgICAgICByYW5kb21pc2VkVmFsdWUgPSBNYXRoLm1heCggcmFuZG9taXNlZFZhbHVlLCAwICk7CiAgICAgICAgcmVmLmNhci5zdGVlcmluZyA9IHJhbmRvbWlzZWRWYWx1ZTsKICAgICAgICAvL2NvbnNvbGUubG9nKCJuZXcgc3RlZXJpbmc6ICIrcmFuZG9taXNlZFZhbHVlKTsKCiAgICAgICAgaWYoIHJlZi5jYXIuc3RlZXJpbmcgPCAwLjUgKSB7CiAgICAgICAgICAvLyBsZWZ0CiAgICAgICAgICBjb25zdCBzdGVlcmluZ1N0cmVuZ3RoID0gKDAuNSAtIHJlZi5jYXIuc3RlZXJpbmcpICogMgogICAgICAgICAgcmVmLmNhci5hbmdsZSAtPSByZWYuY2FyLnN0ZWVyaW5nU3BlZWQgKiBzdGVlcmluZ1N0cmVuZ3RoOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmKCByZWYuY2FyLnN0ZWVyaW5nID4gMC41ICl7CiAgICAgICAgICAvLyByaWdodAogICAgICAgICAgY29uc3Qgc3RlZXJpbmdTdHJlbmd0aCA9IChyZWYuY2FyLnN0ZWVyaW5nIC0gMC41KSAqIDIKICAgICAgICAgIHJlZi5jYXIuYW5nbGUgKz0gcmVmLmNhci5zdGVlcmluZ1NwZWVkICogc3RlZXJpbmdTdHJlbmd0aDsKICAgICAgICB9CgogICAgICAgIHJlZi5jYXIueCArPSBNYXRoLnNpbiggcmVmLmNhci5hbmdsZSApICpyZWYuY2FyLnNwZWVkOwogICAgICAgIHJlZi5jYXIueSAtPSBNYXRoLmNvcyggcmVmLmNhci5hbmdsZSApICpyZWYuY2FyLnNwZWVkOwoKICAgICAgICByZWYuY2hlY2tDYXJDb2xsaXNpb24oKTsKICAgICAgfSk7CiAgICB9LAogICAgZ2V0VmlldygpIHsKICAgICAgLy8gdmlldwogICAgICB0aGlzLmNhci52aWV3WCA9IHRoaXMuY2FyLnggKyBNYXRoLnNpbiggdGhpcy5jYXIuYW5nbGUgKSAqICh0aGlzLmNhci5sZW5ndGgqMCt0aGlzLnZpZXdTaXplLzIpOwogICAgICB0aGlzLmNhci52aWV3WSA9IHRoaXMuY2FyLnkgLSBNYXRoLmNvcyggdGhpcy5jYXIuYW5nbGUgKSAqICh0aGlzLmNhci5sZW5ndGgqMCt0aGlzLnZpZXdTaXplLzIpOwogICAgICAvLyBnZXQgdmlldyBpbWFnZQogICAgICB0aGlzLnNuYXBzaG90V2hlcmVWaWV3SXMgPSB0aGlzLmN0eC5nZXRJbWFnZURhdGEoIHRoaXMuY2FyLnZpZXdYIC0gdGhpcy5jdHhWaWV3U25hcHNob3QuY2FudmFzLndpZHRoLzIsIHRoaXMuY2FyLnZpZXdZIC0gdGhpcy5jdHhWaWV3U25hcHNob3QuY2FudmFzLmhlaWdodC8yLCB0aGlzLmN0eFZpZXdTbmFwc2hvdC5jYW52YXMud2lkdGgsIHRoaXMuY3R4Vmlld1NuYXBzaG90LmNhbnZhcy5oZWlnaHQgKTsKICAgICAgLy8gcmVhZCBwaXhlbHMKICAgICAgbGV0IHZpZXdTbmFwc2hvdFBpeGVscyA9IFtdOwogICAgICBmb3IoIGxldCBpID0gMDsgaSA8IHRoaXMuc25hcHNob3RXaGVyZVZpZXdJcy5kYXRhLmxlbmd0aDsgaSArPSA0ICkgewogICAgICAgIGNvbnN0IHIgPSB0aGlzLnNuYXBzaG90V2hlcmVWaWV3SXMuZGF0YVtpXTsKICAgICAgICBjb25zdCBnID0gdGhpcy5zbmFwc2hvdFdoZXJlVmlld0lzLmRhdGFbaSsxXTsKICAgICAgICBjb25zdCBiID0gdGhpcy5zbmFwc2hvdFdoZXJlVmlld0lzLmRhdGFbaSsyXTsKICAgICAgICB2aWV3U25hcHNob3RQaXhlbHMucHVzaCggW3IsZyxiXSApOwogICAgICB9CiAgICAgIC8vIGRyYXcgcm90YXRlZCBpbWFnZQogICAgICB0aGlzLmN0eFZpZXdTbmFwc2hvdC5zYXZlKCk7CiAgICAgIHRoaXMuY3R4Vmlld1NuYXBzaG90LmNsZWFyUmVjdCggMCwgMCwgdGhpcy5jdHhWaWV3U25hcHNob3QuY2FudmFzLndpZHRoLCB0aGlzLmN0eFZpZXdTbmFwc2hvdC5jYW52YXMuaGVpZ2h0ICk7CiAgICAgIHRoaXMuY3R4Vmlld1NuYXBzaG90LnRyYW5zbGF0ZSggdGhpcy5jdHhWaWV3U25hcHNob3QuY2FudmFzLndpZHRoLzIsIHRoaXMuY3R4Vmlld1NuYXBzaG90LmNhbnZhcy5oZWlnaHQvMiApOwogICAgICB0aGlzLmN0eFZpZXdTbmFwc2hvdC5yb3RhdGUoIC10aGlzLmNhci5hbmdsZSApOwogICAgICB0aGlzLmN0eFZpZXdTbmFwc2hvdC50cmFuc2xhdGUoIC10aGlzLmN0eFZpZXdTbmFwc2hvdC5jYW52YXMud2lkdGgvMiwgLXRoaXMuY3R4Vmlld1NuYXBzaG90LmNhbnZhcy5oZWlnaHQvMiApOwogICAgICBmb3IoIGxldCB5ID0gMDsgeSA8IHRoaXMuY3R4Vmlld1NuYXBzaG90LmNhbnZhcy5oZWlnaHQ7IHkrKyApIHsKICAgICAgICBmb3IoIGxldCB4ID0gMDsgeCA8IHRoaXMuY3R4Vmlld1NuYXBzaG90LmNhbnZhcy53aWR0aDsgeCsrICkgewogICAgICAgICAgY29uc3QgcGl4ZWxJbmRleCA9IHkqdGhpcy5jdHhWaWV3U25hcHNob3QuY2FudmFzLndpZHRoICsgeDsKICAgICAgICAgIGNvbnN0IGNvbG9yID0gdGhpcy5yZ2JUb0hleCggdmlld1NuYXBzaG90UGl4ZWxzW3BpeGVsSW5kZXhdWzBdLCB2aWV3U25hcHNob3RQaXhlbHNbcGl4ZWxJbmRleF1bMV0sIHZpZXdTbmFwc2hvdFBpeGVsc1twaXhlbEluZGV4XVsyXSApOwogICAgICAgICAgdGhpcy5jdHhWaWV3U25hcHNob3QuZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgICB0aGlzLmN0eFZpZXdTbmFwc2hvdC5maWxsUmVjdCggeCwgeSwgMS41LCAxLjUgKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5jdHhWaWV3U25hcHNob3QucmVzdG9yZSgpOwogICAgICAvLyBnZXQgdmlldyBpbWFnZQogICAgICB0aGlzLmltZ1doZXJlVmlld0lzID0gdGhpcy5jdHhWaWV3U25hcHNob3QuZ2V0SW1hZ2VEYXRhKCB0aGlzLmN0eFZpZXdTbmFwc2hvdC5jYW52YXMud2lkdGgvMiAtIHRoaXMuY3R4Vmlldy5jYW52YXMud2lkdGgvMiwgdGhpcy5jdHhWaWV3U25hcHNob3QuY2FudmFzLmhlaWdodC8yIC0gdGhpcy5jdHhWaWV3LmNhbnZhcy5oZWlnaHQvMiwgdGhpcy5jdHhWaWV3LmNhbnZhcy53aWR0aCwgdGhpcy5jdHhWaWV3LmNhbnZhcy5oZWlnaHQgKTsKICAgICAgdGhpcy5jdHhWaWV3LnB1dEltYWdlRGF0YSh0aGlzLmltZ1doZXJlVmlld0lzLCAwLCAwKTsKICAgICAgLy8gcmVhZCBwaXhlbHMKICAgICAgbGV0IHZpZXdQaXhlbHMgPSBbXTsKICAgICAgZm9yKCBsZXQgaSA9IDA7IGkgPCB0aGlzLmltZ1doZXJlVmlld0lzLmRhdGEubGVuZ3RoOyBpICs9IDQgKSB7CiAgICAgICAgY29uc3QgciA9IHRoaXMuaW1nV2hlcmVWaWV3SXMuZGF0YVtpXTsKICAgICAgICBjb25zdCBnID0gdGhpcy5pbWdXaGVyZVZpZXdJcy5kYXRhW2krMV07CiAgICAgICAgY29uc3QgYiA9IHRoaXMuaW1nV2hlcmVWaWV3SXMuZGF0YVtpKzJdOwogICAgICAgIHZpZXdQaXhlbHMucHVzaCggW3IsZyxiXSApOwogICAgICB9CiAgICAgIGxldCB2aWV3UGl4ZWxzUmVkdWNlZCA9IHZpZXdQaXhlbHM7CiAgICAgIGZvciggbGV0IGkgPSAwOyBpIDwgdGhpcy52aWV3UmVkdWN0aW9uOyBpKysgKSB7CiAgICAgICAgdmlld1BpeGVsc1JlZHVjZWQgPSB0aGlzLnJlZHVjZVBpeGVscyggdmlld1BpeGVsc1JlZHVjZWQsIE1hdGguc3FydCh2aWV3UGl4ZWxzUmVkdWNlZC5sZW5ndGgpICk7CiAgICAgIH0KICAgICAgLy8gZHJhdyByZWR1Y2VkIHZpZXcKICAgICAgZm9yKCBsZXQgeSA9IDA7IHkgPCB0aGlzLmN0eFZpZXdSZWR1Y2VkLmNhbnZhcy5oZWlnaHQ7IHkrKyApIHsKICAgICAgICBmb3IoIGxldCB4ID0gMDsgeCA8IHRoaXMuY3R4Vmlld1JlZHVjZWQuY2FudmFzLndpZHRoOyB4KysgKSB7CiAgICAgICAgICBjb25zdCBwaXhlbEluZGV4ID0geSp0aGlzLmN0eFZpZXdSZWR1Y2VkLmNhbnZhcy53aWR0aCArIHg7CiAgICAgICAgICBjb25zdCBjb2xvciA9IHRoaXMucmdiVG9IZXgoIHZpZXdQaXhlbHNSZWR1Y2VkW3BpeGVsSW5kZXhdWzBdLCB2aWV3UGl4ZWxzUmVkdWNlZFtwaXhlbEluZGV4XVsxXSwgdmlld1BpeGVsc1JlZHVjZWRbcGl4ZWxJbmRleF1bMl0gKTsKICAgICAgICAgIHRoaXMuY3R4Vmlld1JlZHVjZWQuZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgICB0aGlzLmN0eFZpZXdSZWR1Y2VkLmZpbGxSZWN0KCB4LCB5LCAxLjUsIDEuNSApOwogICAgICAgIH0KICAgICAgfQoKICAgICAgbGV0IHByZXZpb3VzVG90YWxCcmlnaHRuZXNzOwogICAgICAvLyBjcmVhdGUgc2FtcGxlCiAgICAgIGlmKCB0aGlzLnZpZXdQaXhlbHMgKSB7CiAgICAgICAgLy8gaGFzIHByZXZpb3VzIHN0YXRlCiAgICAgICAgdGhpcy5zYW1wbGVzLnVuc2hpZnQoIHsKICAgICAgICAgIHN0YXRlOiB0aGlzLnZpZXdQaXhlbHMsCiAgICAgICAgICBhY3Rpb246IHRoaXMuY2FyLnN0ZWVyaW5nLAogICAgICAgICAgYWN0aW9uUHJlZGljdGVkOiB0aGlzLmNhci5zdGVlcmluZ1ByZWRpY3RlZAogICAgICAgIH0gKTsKICAgICAgICAvL3RoaXMuc2FtcGxlcyA9IHRoaXMuc2FtcGxlcy5zbGljZSgwLHRoaXMuc2FtcGxlc01heExlbmd0aCk7CiAgICAgICAgcHJldmlvdXNUb3RhbEJyaWdodG5lc3MgPSB0aGlzLnRvdGFsQnJpZ2h0bmVzczsKICAgICAgfQoKICAgICAgLy8gc2F2ZSBuZXcgdmlldyBwaXhlbHMKICAgICAgdGhpcy52aWV3UGl4ZWxzID0gW107CiAgICAgIHRoaXMudG90YWxCcmlnaHRuZXNzID0gMDsKICAgICAgZm9yKCBsZXQgaSA9IDA7IGkgPCB2aWV3UGl4ZWxzUmVkdWNlZC5sZW5ndGg7IGkrKyApIHsKICAgICAgICBjb25zdCBicmlnaHRuZXNzID0gKHZpZXdQaXhlbHNSZWR1Y2VkW2ldWzBdICsgdmlld1BpeGVsc1JlZHVjZWRbaV1bMV0gKyB2aWV3UGl4ZWxzUmVkdWNlZFtpXVsyXSkgLyA3NjU7CiAgICAgICAgdGhpcy52aWV3UGl4ZWxzLnB1c2goIGJyaWdodG5lc3MgKTsKICAgICAgICB0aGlzLnRvdGFsQnJpZ2h0bmVzcyArPSBicmlnaHRuZXNzOwogICAgICB9CiAgICAgIHRoaXMudG90YWxCcmlnaHRuZXNzID0gdGhpcy50b3RhbEJyaWdodG5lc3MgLyB0aGlzLnZpZXdQaXhlbHMubGVuZ3RoOwoKICAgICAgaWYoIHRoaXMuc2FtcGxlcy5sZW5ndGggKSB7CiAgICAgICAgY29uc3QgYnJpZ2h0bmVzc0NoYW5nZSA9IHRoaXMudG90YWxCcmlnaHRuZXNzIC0gcHJldmlvdXNUb3RhbEJyaWdodG5lc3M7CiAgICAgICAgY29uc29sZS5sb2coIi0tLSIpOwogICAgICAgIC8vY29uc29sZS5sb2coICJ0b3RhbEJyaWdodG5lc3M6ICIrIHRoaXMudG90YWxCcmlnaHRuZXNzICk7CiAgICAgICAgLy9jb25zb2xlLmxvZyggInByZXZpb3VzVG90YWxCcmlnaHRuZXNzOiAiKyBwcmV2aW91c1RvdGFsQnJpZ2h0bmVzcyApOwogICAgICAgIC8vY29uc29sZS5sb2coICJicmlnaHRuZXNzQ2hhbmdlOiAiKyBicmlnaHRuZXNzQ2hhbmdlICk7CiAgICAgICAgbGV0IHJld2FyZDsKICAgICAgICBpZiggYnJpZ2h0bmVzc0NoYW5nZSA+PSAwICkgewogICAgICAgICAgLy8gYmV0dGVyCiAgICAgICAgICAvKgogICAgICAgICAgaWYoIHRoaXMudG90YWxCcmlnaHRuZXNzID4gMC41ICkgewogICAgICAgICAgICAvLyBub3Qgc28gYmFkIHNpdHVhdGlvbgogICAgICAgICAgICByZXdhcmQgPSAxOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIC8vIGJhZCBzaXR1YXRpb24KICAgICAgICAgICAgcmV3YXJkID0gMC43NSArIE1hdGgubWluKCAwLjI1LCBicmlnaHRuZXNzQ2hhbmdlKjEwICogdGhpcy50b3RhbEJyaWdodG5lc3MgKTsKICAgICAgICAgIH0KICAgICAgICAgICovCiAgICAgICAgICByZXdhcmQgPSAxOwogICAgICAgICAgLy9jb25zb2xlLmxvZyhyZXdhcmQrIjogYmV0dGVyIik7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgLyoKICAgICAgICAgIC8vIHdvcnNlCiAgICAgICAgICBpZiggdGhpcy50b3RhbEJyaWdodG5lc3MgPCAwLjUgKSB7CiAgICAgICAgICAgIC8vIGJhZCBzaXR1YXRpb24KICAgICAgICAgICAgcmV3YXJkID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAvLyBiYWQgc2l0dWF0aW9uCiAgICAgICAgICAgIHJld2FyZCA9IE1hdGgubWluKCAwLjI1LCBNYXRoLmFicyhicmlnaHRuZXNzQ2hhbmdlKSoxMCAqIHRoaXMudG90YWxCcmlnaHRuZXNzICk7CiAgICAgICAgICB9CiAgICAgICAgICAqLwogICAgICAgICAgcmV3YXJkID0gMDsKICAgICAgICAgIC8vY29uc29sZS5sb2cocmV3YXJkKyI6IHdvcnNlIik7CiAgICAgICAgfQogICAgICAgIHRoaXMuc2FtcGxlc1swXS5yZXdhcmQgPSByZXdhcmQ7CgoKICAgICAgICAvLyBjYWxjdWxhdGUgdG90YWwgYWNjdWFyY3kKICAgICAgICBpZiggcmV3YXJkIDwgMC41ICkgewogICAgICAgICAgdGhpcy5iYWRSZXdhcmRzKys7CiAgICAgICAgICB0aGlzLmJhZFJld2FyZHNJbkFSb3crKzsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICB0aGlzLmJhZFJld2FyZHNJbkFSb3cgPSAwOwogICAgICAgIH0KCgogICAgICAgIC8vIHRyaW0gc2FtcGxlczoKICAgICAgICBpZiggdGhpcy5zYW1wbGVzLmxlbmd0aCA9PT0gdGhpcy5zYW1wbGVzTWF4TGVuZ3RoICkgewogICAgICAgICAgLy9jb25zb2xlLmxvZygibWF4IGxlbmd0aCByZWFjaGVkOiAiK3RoaXMuc2FtcGxlcy5sZW5ndGgpOwogICAgICAgICAgaWYoIHRoaXMuc2FtcGxlc1t0aGlzLnNhbXBsZXMubGVuZ3RoLTFdLnJld2FyZCA8IDAuNSApIHsKICAgICAgICAgICAgLy9jb25zb2xlLmxvZygibGFzdCBpcyBiYWRSZXdhcmQiKTsKICAgICAgICAgICAgdGhpcy5iYWRSZXdhcmRzLS07CiAgICAgICAgICB9CiAgICAgICAgICAvL2NvbnNvbGUubG9nKCJyZW1vdmUiKTsKICAgICAgICAgIHRoaXMuc2FtcGxlcyA9IHRoaXMuc2FtcGxlcy5zbGljZSgwLHRoaXMuc2FtcGxlc01heExlbmd0aC0xKTsKICAgICAgICAgIC8vY29uc29sZS5sb2coIm5ldyBsZW5ndGg6ICIgK3RoaXMuc2FtcGxlcy5sZW5ndGgpOwogICAgICAgIH0KICAgICAgICBjb25zb2xlLmxvZyggImdvb2Qgc2FtcGxlczogIisodGhpcy5zYW1wbGVzLmxlbmd0aC10aGlzLmJhZFJld2FyZHMpICsiIG9mICIrdGhpcy5zYW1wbGVzLmxlbmd0aCk7CgogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIC8vIGZpcnN0IGN5Y2xlCiAgICAgICAgdGhpcy5iYWRSZXdhcmRzID0gMDsKICAgICAgICB0aGlzLmJhZFJld2FyZHNJbkFSb3cgPSAwOwogICAgICB9CgogICAgfSwKICAgIGNoZWNrQ2FyQ29sbGlzaW9uKCkgewogICAgICAvLyBnZXQgY2FyIGltYWdlCiAgICAgIHRoaXMuc25hcHNob3RXaGVyZUNhcklzID0gdGhpcy5jdHguZ2V0SW1hZ2VEYXRhKCB0aGlzLmNhci54IC0gdGhpcy5jdHhDYXJTbmFwc2hvdC5jYW52YXMud2lkdGgvMiwgdGhpcy5jYXIueSAtIHRoaXMuY3R4Q2FyU25hcHNob3QuY2FudmFzLmhlaWdodC8yLCB0aGlzLmN0eENhclNuYXBzaG90LmNhbnZhcy53aWR0aCwgdGhpcy5jdHhDYXJTbmFwc2hvdC5jYW52YXMuaGVpZ2h0ICk7CiAgICAgIC8vIHJlYWQgcGl4ZWxzCiAgICAgIGxldCBjYXJTbmFwc2hvdFBpeGVscyA9IFtdOwogICAgICBmb3IoIGxldCBpID0gMDsgaSA8IHRoaXMuc25hcHNob3RXaGVyZUNhcklzLmRhdGEubGVuZ3RoOyBpICs9IDQgKSB7CiAgICAgICAgY29uc3QgciA9IHRoaXMuc25hcHNob3RXaGVyZUNhcklzLmRhdGFbaV07CiAgICAgICAgY29uc3QgZyA9IHRoaXMuc25hcHNob3RXaGVyZUNhcklzLmRhdGFbaSsxXTsKICAgICAgICBjb25zdCBiID0gdGhpcy5zbmFwc2hvdFdoZXJlQ2FySXMuZGF0YVtpKzJdOwogICAgICAgIGNhclNuYXBzaG90UGl4ZWxzLnB1c2goIFtyLGcsYl0gKTsKICAgICAgfQogICAgICAvLyBkcmF3IHJvdGF0ZWQgaW1hZ2UKICAgICAgdGhpcy5jdHhDYXJTbmFwc2hvdC5zYXZlKCk7CiAgICAgIHRoaXMuY3R4Q2FyU25hcHNob3QuY2xlYXJSZWN0KCAwLCAwLCB0aGlzLmN0eENhclNuYXBzaG90LmNhbnZhcy53aWR0aCwgdGhpcy5jdHhDYXJTbmFwc2hvdC5jYW52YXMuaGVpZ2h0ICk7CiAgICAgIHRoaXMuY3R4Q2FyU25hcHNob3QudHJhbnNsYXRlKCB0aGlzLmN0eENhclNuYXBzaG90LmNhbnZhcy53aWR0aC8yLCB0aGlzLmN0eENhclNuYXBzaG90LmNhbnZhcy5oZWlnaHQvMiApOwogICAgICB0aGlzLmN0eENhclNuYXBzaG90LnJvdGF0ZSggLXRoaXMuY2FyLmFuZ2xlICk7CiAgICAgIHRoaXMuY3R4Q2FyU25hcHNob3QudHJhbnNsYXRlKCAtdGhpcy5jdHhDYXJTbmFwc2hvdC5jYW52YXMud2lkdGgvMiwgLXRoaXMuY3R4Q2FyU25hcHNob3QuY2FudmFzLmhlaWdodC8yICk7CiAgICAgIGZvciggbGV0IHkgPSAwOyB5IDwgdGhpcy5jdHhDYXJTbmFwc2hvdC5jYW52YXMuaGVpZ2h0OyB5KysgKSB7CiAgICAgICAgZm9yKCBsZXQgeCA9IDA7IHggPCB0aGlzLmN0eENhclNuYXBzaG90LmNhbnZhcy53aWR0aDsgeCsrICkgewogICAgICAgICAgY29uc3QgcGl4ZWxJbmRleCA9IHkqdGhpcy5jdHhDYXJTbmFwc2hvdC5jYW52YXMud2lkdGggKyB4OwogICAgICAgICAgY29uc3QgY29sb3IgPSB0aGlzLnJnYlRvSGV4KCBjYXJTbmFwc2hvdFBpeGVsc1twaXhlbEluZGV4XVswXSwgY2FyU25hcHNob3RQaXhlbHNbcGl4ZWxJbmRleF1bMV0sIGNhclNuYXBzaG90UGl4ZWxzW3BpeGVsSW5kZXhdWzJdICk7CiAgICAgICAgICB0aGlzLmN0eENhclNuYXBzaG90LmZpbGxTdHlsZSA9IGNvbG9yOwogICAgICAgICAgdGhpcy5jdHhDYXJTbmFwc2hvdC5maWxsUmVjdCggeCwgeSwgMS41LCAxLjUgKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5jdHhDYXJTbmFwc2hvdC5yZXN0b3JlKCk7CiAgICAgIC8vIGdldCBjYXIgaW1hZ2UKICAgICAgdGhpcy5pbWdXaGVyZUNhcklzID0gdGhpcy5jdHhDYXJTbmFwc2hvdC5nZXRJbWFnZURhdGEoIHRoaXMuY3R4Q2FyU25hcHNob3QuY2FudmFzLndpZHRoLzIgLSB0aGlzLmN0eENhci5jYW52YXMud2lkdGgvMiwgdGhpcy5jdHhDYXJTbmFwc2hvdC5jYW52YXMuaGVpZ2h0LzIgLSB0aGlzLmN0eENhci5jYW52YXMuaGVpZ2h0LzIsIHRoaXMuY3R4Q2FyLmNhbnZhcy53aWR0aCwgdGhpcy5jdHhDYXIuY2FudmFzLmhlaWdodCApOwogICAgICB0aGlzLmN0eENhci5wdXRJbWFnZURhdGEodGhpcy5pbWdXaGVyZUNhcklzLCAwLCAwKTsKCgoKICAgICAgdGhpcy5kcmF3Q2FyQW5kVmlld1NxdWFyZSgpOwoKCiAgICAgIC8vIHJlYWQgcGl4ZWxzCiAgICAgIGxldCB0b3RhbFIgPSAwOwogICAgICBsZXQgdG90YWxHID0gMDsKICAgICAgbGV0IHRvdGFsQiA9IDA7CiAgICAgIGZvciggbGV0IGkgPSAwOyBpIDwgdGhpcy5pbWdXaGVyZUNhcklzLmRhdGEubGVuZ3RoOyBpICs9IDQgKSB7CiAgICAgICAgdG90YWxSICs9IHRoaXMuaW1nV2hlcmVDYXJJcy5kYXRhW2ldOwogICAgICAgIHRvdGFsRyArPSB0aGlzLmltZ1doZXJlQ2FySXMuZGF0YVtpKzFdOwogICAgICAgIHRvdGFsQiArPSB0aGlzLmltZ1doZXJlQ2FySXMuZGF0YVtpKzJdOwogICAgICB9CiAgICAgIHRvdGFsUiA9IE1hdGgucm91bmQoIHRvdGFsUiAvICh0aGlzLmltZ1doZXJlQ2FySXMuZGF0YS5sZW5ndGggLzQpICk7CiAgICAgIHRvdGFsRyA9IE1hdGgucm91bmQoIHRvdGFsRyAvICh0aGlzLmltZ1doZXJlQ2FySXMuZGF0YS5sZW5ndGggLzQpICk7CiAgICAgIHRvdGFsQiA9IE1hdGgucm91bmQoIHRvdGFsQiAvICh0aGlzLmltZ1doZXJlQ2FySXMuZGF0YS5sZW5ndGggLzQpICk7CiAgICAgIGlmKCB0b3RhbFIgKyB0b3RhbEcgKyB0b3RhbEIgPCA3NjAgKSB7CiAgICAgICAgY29uc29sZS5sb2coImNvbGxpc2lvbiEiKTsKCiAgICAgICAgdGhpcy52aWV3UGl4ZWxzID0gbnVsbDsKICAgICAgICB0aGlzLmNhci5zdGVlcmluZyA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLnJlc2V0Q2FyKCk7CgogICAgICAgIGlmKCB0aGlzLmhpZ2hzY29yZXMubGVuZ3RoIDwgdGhpcy5oaWdoc2NvcmVzTWF4TGVuZ3RoIHx8IHRoaXMuc2NvcmUgPiB0aGlzLmhpZ2hzY29yZXNbdGhpcy5oaWdoc2NvcmVzTWF4TGVuZ3RoLTFdLnNjb3JlICkgewogICAgICAgICAgY29uc29sZS5sb2coIm5ldyBoaWdoc2NvcmUiKTsKCiAgICAgICAgICB0aGlzLmhpZ2hzY29yZXMucHVzaCggewogICAgICAgICAgICBzY29yZTogdGhpcy5zY29yZSwKICAgICAgICAgICAgc2FtcGxlczogWy4uLnRoaXMuc2FtcGxlc10sCiAgICAgICAgICAgIG1vZGVsSW5kZXg6IHRoaXMubW9kZWxJbmRleAogICAgICAgICAgfSApOwogICAgICAgICAgdGhpcy5oaWdoc2NvcmVzLnNvcnQoZnVuY3Rpb24oYSwgYil7cmV0dXJuIGIuc2NvcmUgLSBhLnNjb3JlfSk7CiAgICAgICAgICB0aGlzLmhpZ2hzY29yZXMgPSB0aGlzLmhpZ2hzY29yZXMuc2xpY2UoMCx0aGlzLmhpZ2hzY29yZXNNYXhMZW5ndGgpOwogICAgICAgIH0KICAgICAgICBjb25zb2xlLmxvZygidHJhaW4iKTsKICAgICAgICB0aGlzLnRyYWluKCk7CgogICAgICAgIHRoaXMuZHJhd1N0YXRzKCk7CgogICAgICAgIHRoaXMuc2FtcGxlcyA9IFtdOwogICAgICAgIHRoaXMubGFzdFNjb3JlID0gdGhpcy5zY29yZTsKICAgICAgICB0aGlzLnNjb3JlID0gMDsKCiAgICAgICAgLy90aGlzLnJlZnJlc2hMb29wID0gbnVsbDsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICB0aGlzLnNjb3JlKys7CiAgICAgICAgdGhpcy5kcmF3U3RhdHMoKTsKICAgICAgfQogICAgfSwKICAgIGRyYXdDYXJBbmRWaWV3U3F1YXJlKCkgewogICAgICAvLyBkcmF3IGNhcgogICAgICB0aGlzLmN0eC5zYXZlKCk7CiAgICAgIHRoaXMuY3R4LnRyYW5zbGF0ZSggdGhpcy5jYXIueCwgdGhpcy5jYXIueSApOwogICAgICB0aGlzLmN0eC5yb3RhdGUoIHRoaXMuY2FyLmFuZ2xlICk7CiAgICAgIHRoaXMuY3R4LnRyYW5zbGF0ZSggLXRoaXMuY2FyLngsIC10aGlzLmNhci55ICk7CiAgICAgIHRoaXMuY3R4LmZpbGxSZWN0KCB0aGlzLmNhci54IC10aGlzLmNhci53aWR0aC8yLCB0aGlzLmNhci55IC10aGlzLmNhci5sZW5ndGgvMiwgdGhpcy5jYXIud2lkdGgsIHRoaXMuY2FyLmxlbmd0aCApOwogICAgICB0aGlzLmN0eC5yZXN0b3JlKCk7CgogICAgICAvLyBkcmF3IHZpZXcgcmVjdAogICAgICB0aGlzLmN0eC5zYXZlKCk7CiAgICAgIHRoaXMuY3R4LnRyYW5zbGF0ZSggdGhpcy5jYXIudmlld1gsIHRoaXMuY2FyLnZpZXdZICk7CiAgICAgIHRoaXMuY3R4LnJvdGF0ZSggdGhpcy5jYXIuYW5nbGUgKTsKICAgICAgdGhpcy5jdHgudHJhbnNsYXRlKCAtdGhpcy5jYXIudmlld1gsIC10aGlzLmNhci52aWV3WSApOwogICAgICB0aGlzLmN0eC5zdHJva2VTdHlsZSA9ICIjZmYwMDAwIjsKICAgICAgdGhpcy5jdHguYmVnaW5QYXRoKCk7CiAgICAgIHRoaXMuY3R4LnJlY3QoIHRoaXMuY2FyLnZpZXdYIC10aGlzLmN0eFZpZXcuY2FudmFzLndpZHRoLzIsIHRoaXMuY2FyLnZpZXdZIC10aGlzLmN0eFZpZXcuY2FudmFzLmhlaWdodC8yLCB0aGlzLmN0eFZpZXcuY2FudmFzLndpZHRoLCB0aGlzLmN0eFZpZXcuY2FudmFzLmhlaWdodCApOwogICAgICB0aGlzLmN0eC5zdHJva2UoKTsKICAgICAgdGhpcy5jdHgucmVzdG9yZSgpOwogICAgfSwKICAgIGNvbXBvbmVudFRvSGV4KGMpIHsKICAgICAgdmFyIGhleCA9IGMudG9TdHJpbmcoMTYpOwogICAgICByZXR1cm4gaGV4Lmxlbmd0aCA9PSAxID8gIjAiICsgaGV4IDogaGV4OwogICAgfSwKICAgIHJnYlRvSGV4KHIsIGcsIGIpIHsKICAgICAgcmV0dXJuICIjIiArIHRoaXMuY29tcG9uZW50VG9IZXgocikgKyB0aGlzLmNvbXBvbmVudFRvSGV4KGcpICsgdGhpcy5jb21wb25lbnRUb0hleChiKTsKICAgIH0sCiAgICByZWR1Y2VQaXhlbHMocGl4ZWxzLHNpemUpIHsKICAgICAgLy8gcmVkdWNlIHJlc29sdXRpb24KICAgICAgbGV0IHBpeGVsc1JlZHVjZWQgPSBbXTsKICAgICAgZm9yKCBsZXQgeSA9IDA7IHkgPCBzaXplOyB5Kz0yICkgewogICAgICAgIGZvciggbGV0IHggPSAwOyB4IDwgc2l6ZTsgeCs9MiApIHsKICAgICAgICAgIGNvbnN0IHBpeGVsSW5kZXhlcyA9IFsKICAgICAgICAgICAgeSpzaXplICsgeCwKICAgICAgICAgICAgeSpzaXplICsgeCArMSwKICAgICAgICAgICAgKHkrMSkqc2l6ZSArIHgsCiAgICAgICAgICAgICh5KzEpKnNpemUgKyB4ICsxLAogICAgICAgICAgXTsKCiAgICAgICAgICBsZXQgdG90YWxSID0gMDsKICAgICAgICAgIGxldCB0b3RhbEcgPSAwOwogICAgICAgICAgbGV0IHRvdGFsQiA9IDA7CiAgICAgICAgICBmb3IoIGxldCBpID0gMDsgaSA8IHBpeGVsSW5kZXhlcy5sZW5ndGg7IGkrKyApIHsKICAgICAgICAgICAgdG90YWxSICs9IHBpeGVsc1twaXhlbEluZGV4ZXNbaV1dWzBdOwogICAgICAgICAgICB0b3RhbEcgKz0gcGl4ZWxzW3BpeGVsSW5kZXhlc1tpXV1bMV07CiAgICAgICAgICAgIHRvdGFsQiArPSBwaXhlbHNbcGl4ZWxJbmRleGVzW2ldXVsyXTsKICAgICAgICAgIH0KICAgICAgICAgIHRvdGFsUiA9IE1hdGgucm91bmQoIHRvdGFsUiAvIHBpeGVsSW5kZXhlcy5sZW5ndGggKTsKICAgICAgICAgIHRvdGFsRyA9IE1hdGgucm91bmQoIHRvdGFsRyAvIHBpeGVsSW5kZXhlcy5sZW5ndGggKTsKICAgICAgICAgIHRvdGFsQiA9IE1hdGgucm91bmQoIHRvdGFsQiAvIHBpeGVsSW5kZXhlcy5sZW5ndGggKTsKICAgICAgICAgIHBpeGVsc1JlZHVjZWQucHVzaCggW3RvdGFsUix0b3RhbEcsdG90YWxCXSApOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcGl4ZWxzUmVkdWNlZDsKICAgIH0sCiAgICBkcmF3V29ybGQoKSB7CiAgICAgIHRoaXMuY3R4LmNsZWFyUmVjdCggMCwgMCwgdGhpcy5jdHguY2FudmFzLndpZHRoLCB0aGlzLmN0eC5jYW52YXMuaGVpZ2h0ICk7CiAgICAgIHRoaXMuY3R4LmRyYXdJbWFnZSggdGhpcy5pbWdXb3JsZCwgMCwgMCwgdGhpcy5jdHguY2FudmFzLndpZHRoLCB0aGlzLmN0eC5jYW52YXMuaGVpZ2h0ICk7CiAgICB9LAogICAgcmVzZXRDYXIoKSB7CiAgICAgIGNvbnNvbGUubG9nKCAicmVzZXQgY2FyIik7CiAgICAgIHRoaXMuY2FyLnggPSB0aGlzLndvcmxkV2lkdGggLyAyICogMC4yNTsKICAgICAgdGhpcy5jYXIueSA9IHRoaXMud29ybGRIZWlnaHQgLyAyICogMS41OwogICAgICB0aGlzLmNhci5hbmdsZSA9IDA7CiAgICB9LAogICAgLyoKICAgIGtleURvd24oZSkgewogICAgICBpZiggZS5jb2RlID09PSAiQXJyb3dMZWZ0IiApIHsKICAgICAgICB0aGlzLmNhci5zdGVlcmluZyA9IDA7CiAgICAgIH0KICAgICAgZWxzZSBpZiggZS5jb2RlID09PSAiQXJyb3dSaWdodCIgKSB7CiAgICAgICAgdGhpcy5jYXIuc3RlZXJpbmcgPSAxOwogICAgICB9CiAgICB9LAogICAga2V5VXAoZSkgewogICAgICBpZiggZS5jb2RlID09PSAiQXJyb3dMZWZ0IiApIHsKICAgICAgICB0aGlzLmNhci5zdGVlcmluZyA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgICBlbHNlIGlmKCBlLmNvZGUgPT09ICJBcnJvd1JpZ2h0IiApIHsKICAgICAgICB0aGlzLmNhci5zdGVlcmluZyA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgfQogICAgKi8KICB9Cn0K"},{"version":3,"sources":["App.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAwDA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AAIA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"App.vue","sourceRoot":"src","sourcesContent":["<template>\n  <div id=\"app\">\n    <div class=\"world\">\n      <canvas class=\"world-canvas\" ref=\"canvas\" :width=\"worldWidth\" :height=\"worldHeight\"></canvas>\n      <div class=\"training\" v-if=\"training\"><span>TRAINING<br>{{trainingProgress}}% ({{trainingSamples.length}})</span></div>\n    </div>\n    <canvas class=\"car-snapshot-canvas\" ref=\"carSnapshotCanvas\" :width=\"car.length*1.5\" :height=\"car.length*1.5\"></canvas>\n    <canvas class=\"view-snapshot-canvas\" ref=\"viewSnapshotCanvas\" :width=\"viewSize*1.5\" :height=\"viewSize*1.5\"></canvas>\n    <canvas class=\"car-canvas\" ref=\"carCanvas\" :width=\"car.width\" :height=\"car.length\"></canvas>\n    <canvas class=\"view-canvas\" ref=\"viewCanvas\" :width=\"viewSize\" :height=\"viewSize\"></canvas>\n    <canvas class=\"view-canvas-reduced\" ref=\"viewCanvasReduced\" :width=\"reducedViewSize\" :height=\"reducedViewSize\"></canvas>\n    <span class=\"fps\">{{ fps }} fps</span>\n    <div class=\"highscores\">\n      <div class=\"duration\">\n        <label>Total Duration</label>\n        {{durationString}}\n      </div>\n      <label>Highscores ({{highscores.length}})</label>\n      <ul>\n        <li v-for=\"(highscore,index) in highscoresShown\" :key=\"index\"><b>{{models[highscore.modelIndex].name}} - </b> {{highscore.score}}</li>\n        <!-- <li v-if=\"highscores.length\">last: {{highscores[highscores.length-1].score}}</li> -->\n      </ul>\n    </div>\n    <div class=\"score\">\n      <div class=\"current\">\n        <label>Current Score</label>\n        {{score}}\n      </div>\n      <div class=\"last\">\n        <label>Last Score</label>\n        {{lastScore}}\n      </div>\n    </div>\n    <div class=\"stats\">\n      <canvas class=\"stats-canvas\" ref=\"statsCanvas\" :width=\"40\" :height=\"500\"></canvas>\n    </div>\n    <div class=\"models\">\n      <label>Drivers</label>\n      <ul>\n        <li v-for=\"(model,index) in models\" :key=\"index\" :class=\"{'active':index === modelIndex}\">\n          <template v-if=\"model\">\n            {{ model.name }}\n            <span class=\"layers\">\n              [\n              <template v-for=\"(layer) in model.layers\">{{layer.units}} {{layer.activation}}, </template>\n              ]\n            </span>{{model.highscore||\"–\"}} (t: {{model.trainings}})\n          </template>\n        </li>\n      </ul>\n    </div>\n  </div>\n</template>\n\n<script>\n\nconst tf = require('@tensorflow/tfjs');\n\nexport default {\n  name: 'App',\n  data() {\n    return {\n      ctx: null,\n      worldWidth: 256,\n      worldHeight: 256,\n      imgWorld: null,\n      worldLoaded: false,\n      fps: null,\n      fpsCounter: null,\n      tick: true,\n      tickTime: null,\n      duration: -1,\n      durationString: null,\n      car: {\n        width: 8,\n        length: 16,\n        x: 256 / 2 * 0.25,\n        y: 256 / 2 * 1.5,\n        speed: 0.5,\n        steeringSpeed: 0.025,\n        angle: 0\n      },\n      viewSize: 32,\n      viewReduction: 3,\n      viewReducedSize: null,\n      viewPixels: null,\n      steering: null,\n      samples: [],\n      samplesMaxLength: 4096,\n      trainingSamples: null,\n      trainingSamplesMaxLength: 4096,\n      badRewards: 0,\n      badRewardsInARow: 0,\n      score: 0,\n      lastScore: null,\n      highscores: [],\n      highscoresMaxLength: 15,\n      highscoresMaxShown: 15,\n      training: false,\n      trainingProgress: 0,\n      models: undefined,\n      numberOfModels: 10,\n      modelIndex: 0\n    }\n  },\n  computed: {\n    reducedViewSize() {\n      let reducedSize = this.viewSize;\n      for( let i = 0; i < this.viewReduction; i++ ) {\n        reducedSize = reducedSize / 2;\n      }\n      return reducedSize;\n    },\n    highscoresShown() {\n      return this.highscores.slice(0,this.highscoresMaxShown);\n    }\n  },\n  mounted() {\n    this.ctx = this.$refs.canvas.getContext(\"2d\");\n    this.imgWorld = new Image(this.worldWidth,this.worldHeight);\n    this.imgWorld.src = require('/src/assets/world4.jpg');\n    const app = this;\n    this.imgWorld.onload = function() {\n      app.worldLoaded = true;\n    }\n    //document.addEventListener('keydown', this.keyDown);\n    //document.addEventListener('keyup', this.keyUp);\n\n    this.ctxViewSnapshot = this.$refs.viewSnapshotCanvas.getContext(\"2d\");\n    this.ctxCarSnapshot = this.$refs.carSnapshotCanvas.getContext(\"2d\");\n\n    this.ctxCar = this.$refs.carCanvas.getContext(\"2d\");\n    this.ctxView = this.$refs.viewCanvas.getContext(\"2d\");\n    this.ctxViewReduced = this.$refs.viewCanvasReduced.getContext(\"2d\");\n\n    this.ctxStats = this.$refs.statsCanvas.getContext(\"2d\");\n\n\n    this.viewReducedSize = this.viewSize;\n    for( let i = 0; i < this.viewReduction; i++ ) {\n      this.viewReducedSize = this.viewReducedSize / 2;\n    }\n\n    this.models = new Array(this.numberOfModels);\n    this.createModel(this.modelIndex);\n\n    this.refreshLoop();\n  },\n  methods: {\n    createModel( modelIndex ) {\n      console.log(\"creating model ...\");\n      const numberOfLayers =  2 + Math.round(Math.random());\n      let layers = new Array( numberOfLayers );\n      for( let i = numberOfLayers-1; i >= 0; i-- ) {\n        if( i === numberOfLayers-1 ) {\n          // last layer\n          layers[i] = {\n            units: 1,\n            activation: \"sigmoid\"\n          };\n        }\n        else {\n          layers[i] = {\n            units: 3 + Math.ceil( Math.random()*15 ),\n            activation: [\"relu\",\"sigmoid\"][Math.round(Math.random())]\n          };\n        }\n      }\n      this.models[modelIndex] = {\n        layers: layers,\n        trainings: 0,\n        highscore: undefined,\n        name: modelIndex+1,\n        children: 0\n      };\n\n      // create model with layers\n      this.models[modelIndex].model = tf.sequential();\n      for( let i = 0; i < layers.length; i++ ) {\n        if( i === 0 ) {\n          // first layer\n          this.models[modelIndex].model.add(tf.layers.dense({inputShape: this.viewReducedSize*this.viewReducedSize, activation: layers[i].activation, units: layers[i].units}));\n        }\n        else {\n          this.models[modelIndex].model.add(tf.layers.dense({activation: layers[i].activation, units: layers[i].units}));\n        }\n      }\n      /*\n      this.models[i].model.add(tf.layers.dense({inputShape: this.viewReducedSize*this.viewReducedSize, activation: \"relu\", units: 10}));\n      this.models[i].model.add(tf.layers.dense({activation: \"relu\", units: 5}));\n      this.models[i].model.add(tf.layers.dense({activation: \"sigmoid\", units: 1}));\n      */\n      //this.models[i].add(tf.layers.dense({activation: \"relu\", units: 1}));\n      this.models[modelIndex].model.compile({loss:'binaryCrossentropy',optimizer:tf.train.rmsprop(0.1),metrics:['accuracy']});\n      //this.model.compile({loss:'categoricalCrossentropy',optimizer:tf.train.adam(),metrics:['accuracy']});\n    },\n    async train() {\n\n      // check if new highscore:\n      let highscoreOfModel = this.highscores.find(el => el.modelIndex === this.modelIndex );\n      if( highscoreOfModel ) {\n        this.models[this.modelIndex].highscore = highscoreOfModel.score;\n      }\n\n      // switch to next model\n      this.modelIndex = (this.modelIndex +1) % this.numberOfModels;\n\n      // create or make clone, if necessary\n      if( !this.models[this.modelIndex] ) {\n        this.createModel(this.modelIndex);\n      }\n      else {\n        // check for new highscore\n        let highscoreOfModel = this.highscores.find(el => el.modelIndex === this.modelIndex );\n        if( !highscoreOfModel ) {\n          // replace model\n\n          let random = Math.random();\n          let highscoreIndex;\n          if( random > 1-0.182 ) {\n            highscoreIndex = 0;\n          }\n          else if( random > 1 - 0.182 - 0.163) {\n            highscoreIndex = 1;\n          }\n          else if( random > 1 - 0.182 - 0.163 - 0.146 ) {\n            highscoreIndex = 2;\n          }\n          else if( random > 1 - 0.182 - 0.163 - 0.146 - 0.127 ) {\n            highscoreIndex = 3;\n          }\n          else if( random > 1 - 0.182 - 0.163 - 0.146 - 0.127 - 0.109 ) {\n            highscoreIndex = 4;\n          }\n          else if( random > 1 - 0.182 - 0.163 - 0.146 - 0.127 - 0.109 - 0.091 ) {\n            highscoreIndex = 5;\n          }\n          else if( random > 1 - 0.182 - 0.163 - 0.146 - 0.127 - 0.109 - 0.091 - 0.073 ) {\n            highscoreIndex = 6;\n          }\n          else if( random > 1 - 0.182 - 0.163 - 0.146 - 0.127 - 0.109 - 0.091 - 0.073 - 0.054 ) {\n            highscoreIndex = 7;\n          }\n          else if( random > 1 - 0.182 - 0.163 - 0.146 - 0.127 - 0.109 - 0.091 - 0.073 - 0.054 - 0.037 ) {\n            highscoreIndex = 8;\n          }\n          else if( random > 1 - 0.182 - 0.163 - 0.146 - 0.127 - 0.109 - 0.091 - 0.073 - 0.054 - 0.037 - 0.018 ) {\n            highscoreIndex = 9;\n          }\n\n          const mother = this.models[ this.highscores[highscoreIndex].modelIndex ];\n          this.models[this.modelIndex] = {...mother};\n          this.models[this.modelIndex].trainings = 0;\n          this.models[this.modelIndex].highscore = undefined;\n          mother.children++;\n          this.models[this.modelIndex].name = mother.name+\".\"+mother.children;\n        }\n\n      }\n\n      this.training = true;\n\n      this.trainingSamples = [];\n      for( let i = 0; i < this.highscores.length; i++ ) {\n        let samples = [];\n        for( let j = 0; j < this.highscores[i].samples.length; j++ ) {\n          if( this.highscores[i].samples[j].reward > 0.5 ) {\n            // use only good rewards\n            samples.push( this.highscores[i].samples[j] );\n          }\n        }\n        this.trainingSamples.push(...samples);\n      }\n      // randomise and slice\n      this.trainingSamples.sort(function(){return 0.5 - Math.random()});\n      this.trainingSamples = this.trainingSamples.slice(0,this.trainingSamplesMaxLength);\n\n      console.log(\"total number of samples: \"+this.trainingSamples.length);\n\n      let featureValuesTraining = [];\n      let labelValuesTraining = [];\n      for( let i = 0; i < this.trainingSamples.length; i++ ) {\n        let featureValueTraining = [...this.trainingSamples[i].state];\n        //featureValueTraining.push( this.trainingSamples[i].reward );\n        featureValuesTraining.push( featureValueTraining );\n        labelValuesTraining.push( this.trainingSamples[i].action );\n      }\n      const featureTensorTraining = tf.tensor2d( featureValuesTraining, [featureValuesTraining.length, featureValuesTraining[0].length] );\n      const labelTensorTraining = tf.tensor2d( labelValuesTraining, [labelValuesTraining.length, 1] );\n\n      console.log(\"train model ...\");\n      await this.trainModel( this.modelIndex, featureTensorTraining, labelTensorTraining, Math.min(10, this.trainingSamplesMaxLength/this.trainingSamples.length)*10 );\n\n      this.training = false;\n      this.trainingProgress = 0;\n\n      this.models[this.modelIndex].trainings += 1;\n    },\n    async trainModel( modelIndex, featureTensorTraining, labelTensorTraining, epochs ) {\n      const ref = this;\n      return this.models[modelIndex].model.fit( featureTensorTraining, labelTensorTraining, {\n        epochs,\n        //validationSplit: 0.2,\n        callbacks: {\n          onEpochEnd: function(epoch) {\n            ref.trainingProgress = Math.round( epoch / epochs * 100 );\n          },\n          onTrainEnd: function() {\n            console.log(\"done\");\n          }\n        }\n      });\n    },\n    async predict( modelIndex, input ) {\n      return tf.tidy( () => {\n        const inputTensor = tf.tensor2d([input],[1, this.viewReducedSize*this.viewReducedSize]);\n        const outputTensor = this.models[modelIndex].model.predict( inputTensor );\n        const outputValue = outputTensor.dataSync();\n\n        return outputValue;\n      });\n    },\n    async getSteering() {\n      this.prediction = await this.predict( this.modelIndex, this.testingDataInput );\n      this.prediction = Math.max( 0, this.prediction  )\n      return this.prediction;\n    },\n    refreshLoop() {\n      window.requestAnimationFrame(() => {\n        const now = performance.now();\n        if( this.tick ) {\n          this.tickTime = now;\n          this.fps = this.fpsCounter;\n          this.fpsCounter = 0;\n          this.tick = false;\n\n          this.duration++;\n          const date = new Date(0);\n          date.setSeconds(this.duration); // specify value for SECONDS here\n          this.durationString = date.toISOString().substr(11, 8);\n        }\n        else {\n          this.fpsCounter++;\n          if( now >= this.tickTime + 1000 ) {\n            this.tick = true;\n          }\n        }\n\n        this.enterFrame();\n\n        this.refreshLoop();\n      });\n    },\n    enterFrame() {\n      if( this.worldLoaded && !this.training ) {\n        this.drawWorld();\n        this.getView();\n        this.moveCar();\n      }\n    },\n    drawStats() {\n      this.ctxStats.clearRect( 0, 0, this.ctxStats.canvas.width, this.ctxStats.canvas.height );\n      //this.ctxStats.fillRect(0, 0, this.ctxStats.canvas.width, this.ctxStats.canvas.height);\n      //this.ctxStats.strokeStyle = \"#ffffff\";\n      const numberOfsamplesDrawn = Math.min(512, this.samples.length);\n      for( let i = 0; i < numberOfsamplesDrawn; i++ ) {\n        /*\n        this.ctxStats.moveTo( this.samples[i].action * this.ctxStats.canvas.width, this.ctxStats.canvas.height/this.samples.length * i );\n        this.ctxStats.lineTo( this.samples[i+1].action * this.ctxStats.canvas.width, this.ctxStats.canvas.height/this.samples.length * (i+1) );\n        */\n        this.ctxStats.beginPath();\n        this.ctxStats.fillStyle = \"#ffffff\";\n        this.ctxStats.arc(this.samples[i].actionPredicted * this.ctxStats.canvas.width, this.ctxStats.canvas.height/numberOfsamplesDrawn * i, 1, 0, 2 * Math.PI);\n        this.ctxStats.fill();\n\n        this.ctxStats.beginPath();\n        let rgb;\n        if( this.samples[i].reward >= 0.5 ) {\n          //rgb = \"#00ff00\";\n          rgb = \"#00\"+ Math.round( this.samples[i].reward * 255 ).toString(16) + \"00\";\n          this.ctxStats.fillStyle = rgb;\n          this.ctxStats.arc(this.samples[i].action * this.ctxStats.canvas.width, this.ctxStats.canvas.height/numberOfsamplesDrawn * i, 1, 0, 2 * Math.PI);\n          this.ctxStats.fill();\n        }\n        else {\n          //rgb = \"#ff0000\";\n          rgb = \"#\"+ Math.round( (1-this.samples[i].reward) * 255 ).toString(16) + \"0000\";\n          this.ctxStats.fillStyle = rgb;\n          this.ctxStats.arc(this.samples[i].action * this.ctxStats.canvas.width, this.ctxStats.canvas.height/numberOfsamplesDrawn * i, 1, 0, 2 * Math.PI);\n          this.ctxStats.fill();\n        }\n      }\n      //this.ctxStats.stroke();\n    },\n    moveCar() {\n      this.testingDataInput = [...this.viewPixels];\n      //this.testingDataInput.push(1.0);\n      const ref = this;\n      this.getSteering().then( function(value) {\n        //console.log(\"predicted steering: \"+value);\n        value = Math.min( value, 1 );\n        value = Math.max( value, 0 );\n        //console.log(\"predicted steering: \"+value);\n        ref.car.steeringPredicted = value;\n\n        let randomisation = 0;\n        if( ref.samples[0] ) {\n          if( ref.samples[0].reward < 0.5 ) {\n            randomisation = Math.min( 0.75, (ref.badRewards/ref.samples.length) * ref.badRewardsInARow );\n          }\n          else {\n            randomisation = 0.05;\n          }\n        }\n        else {\n          randomisation = 0.75;\n        }\n\n        //console.log(\"randomisation: \"+randomisation);\n        const random = Math.random();\n        let randomisedValue = value - randomisation*1 + random * randomisation*2;\n        randomisedValue = Math.min( randomisedValue, 1 );\n        randomisedValue = Math.max( randomisedValue, 0 );\n        ref.car.steering = randomisedValue;\n        //console.log(\"new steering: \"+randomisedValue);\n\n        if( ref.car.steering < 0.5 ) {\n          // left\n          const steeringStrength = (0.5 - ref.car.steering) * 2\n          ref.car.angle -= ref.car.steeringSpeed * steeringStrength;\n        }\n        else if( ref.car.steering > 0.5 ){\n          // right\n          const steeringStrength = (ref.car.steering - 0.5) * 2\n          ref.car.angle += ref.car.steeringSpeed * steeringStrength;\n        }\n\n        ref.car.x += Math.sin( ref.car.angle ) *ref.car.speed;\n        ref.car.y -= Math.cos( ref.car.angle ) *ref.car.speed;\n\n        ref.checkCarCollision();\n      });\n    },\n    getView() {\n      // view\n      this.car.viewX = this.car.x + Math.sin( this.car.angle ) * (this.car.length*0+this.viewSize/2);\n      this.car.viewY = this.car.y - Math.cos( this.car.angle ) * (this.car.length*0+this.viewSize/2);\n      // get view image\n      this.snapshotWhereViewIs = this.ctx.getImageData( this.car.viewX - this.ctxViewSnapshot.canvas.width/2, this.car.viewY - this.ctxViewSnapshot.canvas.height/2, this.ctxViewSnapshot.canvas.width, this.ctxViewSnapshot.canvas.height );\n      // read pixels\n      let viewSnapshotPixels = [];\n      for( let i = 0; i < this.snapshotWhereViewIs.data.length; i += 4 ) {\n        const r = this.snapshotWhereViewIs.data[i];\n        const g = this.snapshotWhereViewIs.data[i+1];\n        const b = this.snapshotWhereViewIs.data[i+2];\n        viewSnapshotPixels.push( [r,g,b] );\n      }\n      // draw rotated image\n      this.ctxViewSnapshot.save();\n      this.ctxViewSnapshot.clearRect( 0, 0, this.ctxViewSnapshot.canvas.width, this.ctxViewSnapshot.canvas.height );\n      this.ctxViewSnapshot.translate( this.ctxViewSnapshot.canvas.width/2, this.ctxViewSnapshot.canvas.height/2 );\n      this.ctxViewSnapshot.rotate( -this.car.angle );\n      this.ctxViewSnapshot.translate( -this.ctxViewSnapshot.canvas.width/2, -this.ctxViewSnapshot.canvas.height/2 );\n      for( let y = 0; y < this.ctxViewSnapshot.canvas.height; y++ ) {\n        for( let x = 0; x < this.ctxViewSnapshot.canvas.width; x++ ) {\n          const pixelIndex = y*this.ctxViewSnapshot.canvas.width + x;\n          const color = this.rgbToHex( viewSnapshotPixels[pixelIndex][0], viewSnapshotPixels[pixelIndex][1], viewSnapshotPixels[pixelIndex][2] );\n          this.ctxViewSnapshot.fillStyle = color;\n          this.ctxViewSnapshot.fillRect( x, y, 1.5, 1.5 );\n        }\n      }\n      this.ctxViewSnapshot.restore();\n      // get view image\n      this.imgWhereViewIs = this.ctxViewSnapshot.getImageData( this.ctxViewSnapshot.canvas.width/2 - this.ctxView.canvas.width/2, this.ctxViewSnapshot.canvas.height/2 - this.ctxView.canvas.height/2, this.ctxView.canvas.width, this.ctxView.canvas.height );\n      this.ctxView.putImageData(this.imgWhereViewIs, 0, 0);\n      // read pixels\n      let viewPixels = [];\n      for( let i = 0; i < this.imgWhereViewIs.data.length; i += 4 ) {\n        const r = this.imgWhereViewIs.data[i];\n        const g = this.imgWhereViewIs.data[i+1];\n        const b = this.imgWhereViewIs.data[i+2];\n        viewPixels.push( [r,g,b] );\n      }\n      let viewPixelsReduced = viewPixels;\n      for( let i = 0; i < this.viewReduction; i++ ) {\n        viewPixelsReduced = this.reducePixels( viewPixelsReduced, Math.sqrt(viewPixelsReduced.length) );\n      }\n      // draw reduced view\n      for( let y = 0; y < this.ctxViewReduced.canvas.height; y++ ) {\n        for( let x = 0; x < this.ctxViewReduced.canvas.width; x++ ) {\n          const pixelIndex = y*this.ctxViewReduced.canvas.width + x;\n          const color = this.rgbToHex( viewPixelsReduced[pixelIndex][0], viewPixelsReduced[pixelIndex][1], viewPixelsReduced[pixelIndex][2] );\n          this.ctxViewReduced.fillStyle = color;\n          this.ctxViewReduced.fillRect( x, y, 1.5, 1.5 );\n        }\n      }\n\n      let previousTotalBrightness;\n      // create sample\n      if( this.viewPixels ) {\n        // has previous state\n        this.samples.unshift( {\n          state: this.viewPixels,\n          action: this.car.steering,\n          actionPredicted: this.car.steeringPredicted\n        } );\n        //this.samples = this.samples.slice(0,this.samplesMaxLength);\n        previousTotalBrightness = this.totalBrightness;\n      }\n\n      // save new view pixels\n      this.viewPixels = [];\n      this.totalBrightness = 0;\n      for( let i = 0; i < viewPixelsReduced.length; i++ ) {\n        const brightness = (viewPixelsReduced[i][0] + viewPixelsReduced[i][1] + viewPixelsReduced[i][2]) / 765;\n        this.viewPixels.push( brightness );\n        this.totalBrightness += brightness;\n      }\n      this.totalBrightness = this.totalBrightness / this.viewPixels.length;\n\n      if( this.samples.length ) {\n        const brightnessChange = this.totalBrightness - previousTotalBrightness;\n        console.log(\"---\");\n        //console.log( \"totalBrightness: \"+ this.totalBrightness );\n        //console.log( \"previousTotalBrightness: \"+ previousTotalBrightness );\n        //console.log( \"brightnessChange: \"+ brightnessChange );\n        let reward;\n        if( brightnessChange >= 0 ) {\n          // better\n          /*\n          if( this.totalBrightness > 0.5 ) {\n            // not so bad situation\n            reward = 1;\n          }\n          else {\n            // bad situation\n            reward = 0.75 + Math.min( 0.25, brightnessChange*10 * this.totalBrightness );\n          }\n          */\n          reward = 1;\n          //console.log(reward+\": better\");\n        }\n        else {\n          /*\n          // worse\n          if( this.totalBrightness < 0.5 ) {\n            // bad situation\n            reward = 0;\n          }\n          else {\n            // bad situation\n            reward = Math.min( 0.25, Math.abs(brightnessChange)*10 * this.totalBrightness );\n          }\n          */\n          reward = 0;\n          //console.log(reward+\": worse\");\n        }\n        this.samples[0].reward = reward;\n\n\n        // calculate total accuarcy\n        if( reward < 0.5 ) {\n          this.badRewards++;\n          this.badRewardsInARow++;\n        }\n        else {\n          this.badRewardsInARow = 0;\n        }\n\n\n        // trim samples:\n        if( this.samples.length === this.samplesMaxLength ) {\n          //console.log(\"max length reached: \"+this.samples.length);\n          if( this.samples[this.samples.length-1].reward < 0.5 ) {\n            //console.log(\"last is badReward\");\n            this.badRewards--;\n          }\n          //console.log(\"remove\");\n          this.samples = this.samples.slice(0,this.samplesMaxLength-1);\n          //console.log(\"new length: \" +this.samples.length);\n        }\n        console.log( \"good samples: \"+(this.samples.length-this.badRewards) +\" of \"+this.samples.length);\n\n      }\n      else {\n        // first cycle\n        this.badRewards = 0;\n        this.badRewardsInARow = 0;\n      }\n\n    },\n    checkCarCollision() {\n      // get car image\n      this.snapshotWhereCarIs = this.ctx.getImageData( this.car.x - this.ctxCarSnapshot.canvas.width/2, this.car.y - this.ctxCarSnapshot.canvas.height/2, this.ctxCarSnapshot.canvas.width, this.ctxCarSnapshot.canvas.height );\n      // read pixels\n      let carSnapshotPixels = [];\n      for( let i = 0; i < this.snapshotWhereCarIs.data.length; i += 4 ) {\n        const r = this.snapshotWhereCarIs.data[i];\n        const g = this.snapshotWhereCarIs.data[i+1];\n        const b = this.snapshotWhereCarIs.data[i+2];\n        carSnapshotPixels.push( [r,g,b] );\n      }\n      // draw rotated image\n      this.ctxCarSnapshot.save();\n      this.ctxCarSnapshot.clearRect( 0, 0, this.ctxCarSnapshot.canvas.width, this.ctxCarSnapshot.canvas.height );\n      this.ctxCarSnapshot.translate( this.ctxCarSnapshot.canvas.width/2, this.ctxCarSnapshot.canvas.height/2 );\n      this.ctxCarSnapshot.rotate( -this.car.angle );\n      this.ctxCarSnapshot.translate( -this.ctxCarSnapshot.canvas.width/2, -this.ctxCarSnapshot.canvas.height/2 );\n      for( let y = 0; y < this.ctxCarSnapshot.canvas.height; y++ ) {\n        for( let x = 0; x < this.ctxCarSnapshot.canvas.width; x++ ) {\n          const pixelIndex = y*this.ctxCarSnapshot.canvas.width + x;\n          const color = this.rgbToHex( carSnapshotPixels[pixelIndex][0], carSnapshotPixels[pixelIndex][1], carSnapshotPixels[pixelIndex][2] );\n          this.ctxCarSnapshot.fillStyle = color;\n          this.ctxCarSnapshot.fillRect( x, y, 1.5, 1.5 );\n        }\n      }\n      this.ctxCarSnapshot.restore();\n      // get car image\n      this.imgWhereCarIs = this.ctxCarSnapshot.getImageData( this.ctxCarSnapshot.canvas.width/2 - this.ctxCar.canvas.width/2, this.ctxCarSnapshot.canvas.height/2 - this.ctxCar.canvas.height/2, this.ctxCar.canvas.width, this.ctxCar.canvas.height );\n      this.ctxCar.putImageData(this.imgWhereCarIs, 0, 0);\n\n\n\n      this.drawCarAndViewSquare();\n\n\n      // read pixels\n      let totalR = 0;\n      let totalG = 0;\n      let totalB = 0;\n      for( let i = 0; i < this.imgWhereCarIs.data.length; i += 4 ) {\n        totalR += this.imgWhereCarIs.data[i];\n        totalG += this.imgWhereCarIs.data[i+1];\n        totalB += this.imgWhereCarIs.data[i+2];\n      }\n      totalR = Math.round( totalR / (this.imgWhereCarIs.data.length /4) );\n      totalG = Math.round( totalG / (this.imgWhereCarIs.data.length /4) );\n      totalB = Math.round( totalB / (this.imgWhereCarIs.data.length /4) );\n      if( totalR + totalG + totalB < 760 ) {\n        console.log(\"collision!\");\n\n        this.viewPixels = null;\n        this.car.steering = undefined;\n        this.resetCar();\n\n        if( this.highscores.length < this.highscoresMaxLength || this.score > this.highscores[this.highscoresMaxLength-1].score ) {\n          console.log(\"new highscore\");\n\n          this.highscores.push( {\n            score: this.score,\n            samples: [...this.samples],\n            modelIndex: this.modelIndex\n          } );\n          this.highscores.sort(function(a, b){return b.score - a.score});\n          this.highscores = this.highscores.slice(0,this.highscoresMaxLength);\n        }\n        console.log(\"train\");\n        this.train();\n\n        this.drawStats();\n\n        this.samples = [];\n        this.lastScore = this.score;\n        this.score = 0;\n\n        //this.refreshLoop = null;\n      }\n      else {\n        this.score++;\n        this.drawStats();\n      }\n    },\n    drawCarAndViewSquare() {\n      // draw car\n      this.ctx.save();\n      this.ctx.translate( this.car.x, this.car.y );\n      this.ctx.rotate( this.car.angle );\n      this.ctx.translate( -this.car.x, -this.car.y );\n      this.ctx.fillRect( this.car.x -this.car.width/2, this.car.y -this.car.length/2, this.car.width, this.car.length );\n      this.ctx.restore();\n\n      // draw view rect\n      this.ctx.save();\n      this.ctx.translate( this.car.viewX, this.car.viewY );\n      this.ctx.rotate( this.car.angle );\n      this.ctx.translate( -this.car.viewX, -this.car.viewY );\n      this.ctx.strokeStyle = \"#ff0000\";\n      this.ctx.beginPath();\n      this.ctx.rect( this.car.viewX -this.ctxView.canvas.width/2, this.car.viewY -this.ctxView.canvas.height/2, this.ctxView.canvas.width, this.ctxView.canvas.height );\n      this.ctx.stroke();\n      this.ctx.restore();\n    },\n    componentToHex(c) {\n      var hex = c.toString(16);\n      return hex.length == 1 ? \"0\" + hex : hex;\n    },\n    rgbToHex(r, g, b) {\n      return \"#\" + this.componentToHex(r) + this.componentToHex(g) + this.componentToHex(b);\n    },\n    reducePixels(pixels,size) {\n      // reduce resolution\n      let pixelsReduced = [];\n      for( let y = 0; y < size; y+=2 ) {\n        for( let x = 0; x < size; x+=2 ) {\n          const pixelIndexes = [\n            y*size + x,\n            y*size + x +1,\n            (y+1)*size + x,\n            (y+1)*size + x +1,\n          ];\n\n          let totalR = 0;\n          let totalG = 0;\n          let totalB = 0;\n          for( let i = 0; i < pixelIndexes.length; i++ ) {\n            totalR += pixels[pixelIndexes[i]][0];\n            totalG += pixels[pixelIndexes[i]][1];\n            totalB += pixels[pixelIndexes[i]][2];\n          }\n          totalR = Math.round( totalR / pixelIndexes.length );\n          totalG = Math.round( totalG / pixelIndexes.length );\n          totalB = Math.round( totalB / pixelIndexes.length );\n          pixelsReduced.push( [totalR,totalG,totalB] );\n        }\n      }\n      return pixelsReduced;\n    },\n    drawWorld() {\n      this.ctx.clearRect( 0, 0, this.ctx.canvas.width, this.ctx.canvas.height );\n      this.ctx.drawImage( this.imgWorld, 0, 0, this.ctx.canvas.width, this.ctx.canvas.height );\n    },\n    resetCar() {\n      console.log( \"reset car\");\n      this.car.x = this.worldWidth / 2 * 0.25;\n      this.car.y = this.worldHeight / 2 * 1.5;\n      this.car.angle = 0;\n    },\n    /*\n    keyDown(e) {\n      if( e.code === \"ArrowLeft\" ) {\n        this.car.steering = 0;\n      }\n      else if( e.code === \"ArrowRight\" ) {\n        this.car.steering = 1;\n      }\n    },\n    keyUp(e) {\n      if( e.code === \"ArrowLeft\" ) {\n        this.car.steering = undefined;\n      }\n      else if( e.code === \"ArrowRight\" ) {\n        this.car.steering = undefined;\n      }\n    }\n    */\n  }\n}\n</script>\n\n<style lang=\"scss\">\n\nbody {\n  margin: 0;\n  height: 100vh;\n  font-family: sans-serif;\n  font-size: 16px;\n  line-height: 150%;\n  background-color: black;\n  color: white;\n}\nlabel {\n  font-size: 13px;\n}\n#app {\n  height: 100%;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  margin: auto;\n  max-width: 100vh;\n}\n\n.world {\n  position: relative;\n  width: 100%;\n  height: 0;\n  padding-top: 100%;\n  .world-canvas {\n    position: absolute;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n  }\n  .training {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 20%;\n    height: 20%;\n    position: absolute;\n    top: 40%;\n    left: 40%;\n    span {\n      text-align: center;\n    }\n  }\n}\n\n\n.car-snapshot-canvas {\n  position: absolute;\n  top: 8px;\n  left: 8px;\n  border: 1px solid white;\n  image-rendering: pixelated;\n  width: 10%;\n  display: none;\n}\n.car-canvas {\n  position: absolute;\n  bottom: 8px;\n  left: 8px;\n  border: 1px solid white;\n  image-rendering: pixelated;\n  width: 15%;\n  display: none;\n}\n.view-snapshot-canvas {\n  position: absolute;\n  top: 8px;\n  right: 8px;\n  border: 1px solid white;\n  image-rendering: pixelated;\n  width: 10%;\n  display: none;\n}\n.view-canvas {\n  position: absolute;\n  bottom: 8px;\n  right: 8px;\n  border: 1px solid white;\n  image-rendering: pixelated;\n  width: 10%;\n  display: none;\n}\n.view-canvas-reduced {\n  position: absolute;\n  bottom: 8px;\n  right: 8px;\n  border: 1px solid red;\n  image-rendering: pixelated;\n  width: 15%;\n}\n\n\n\n.fps {\n  position: absolute;\n  top: 8px;\n  left: 50%;\n  color: #333333;\n}\n\n.highscores {\n  position: absolute;\n  top: 16px;\n  right: 16px;\n  text-align: right;\n\n  .duration {\n    margin-bottom: 16px;\n  }\n\n  label {\n    display: block;\n    font-weight: bold;\n    margin-bottom: 8px;\n  }\n  ul {\n    list-style: none;\n    margin: 0;\n    padding: 0;\n    li {\n      &:first-child {\n        font-size: 20px;\n        line-height: 150%;\n      }\n      &:nth-child(2),\n      &:nth-child(3) {\n        font-size: 16px;\n        line-height: 20px;\n      }\n      display: block;\n      font-size: 13px;\n      line-height: 16px;\n    }\n  }\n\n}\n\n\n.score {\n  position: absolute;\n  right: calc( 15% + 48px);\n  bottom: 48px;\n  text-align: right;\n  label {\n    display: block;\n    font-weight: bold;\n    margin-bottom: 8px;\n  }\n\n  .last {\n    margin-top: 16px;\n    font-size: 25px;\n    label {\n      font-size: 16px;\n    }\n  }\n}\n\n.stats {\n  position: absolute;\n  top: 0;\n  left: 0;\n  height: 100%;\n  .stats-canvas {\n    height: 100%;\n    border-right: 1px solid #333;\n  }\n  &:before {\n    content: '';\n    position: absolute;\n    display: block;\n    width: 50%;\n    height: 100%;\n    border-right: 1px solid #666666;\n  }\n}\n\n.models {\n  position: absolute;\n  top: 0;\n  left: 7.5%;\n  label {\n    display: block;\n    font-weight: bold;\n    margin-bottom: 8px;\n  }\n  ul {\n    list-style: none;\n    padding: 0;\n    margin: 0;\n    li {\n      color: #cccccc;\n      font-size: 13px;\n      line-height: 125%;\n      &.active {\n        font-weight: bold;\n        font-size: 25px;\n      }\n      .layers {\n        font-size: 10px;\n      }\n    }\n  }\n}\n\n</style>\n"]}]}